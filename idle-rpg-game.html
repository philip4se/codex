<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î∞©ÏπòÌòï RPG Í≤åÏûÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .game-header h1 {
            font-size: 36px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .stage-info {
            font-size: 18px;
            color: #ffeb3b;
        }

        .main-game {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .side-panel {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
        }

        .center-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .battlefield {
            min-height: 400px;
            position: relative;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .team-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .character-slot {
            width: 80px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #666;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .character-slot:hover {
            border-color: #4CAF50;
            transform: scale(1.05);
        }

        .character-slot.active {
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }

        .character-sprite {
            width: 48px;
            height: 48px;
            image-rendering: pixelated;
            margin-bottom: 5px;
        }

        .character-hp-bar {
            width: 90%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .character-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            transition: width 0.3s;
        }

        .character-mp-bar {
            width: 90%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 2px;
        }

        .character-mp-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.3s;
        }

        .character-name {
            font-size: 10px;
            color: #fff;
            text-align: center;
        }

        .character-level {
            font-size: 9px;
            color: #ffeb3b;
        }

        .enemy-container {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .enemy-slot {
            width: 70px;
            height: 90px;
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .enemy-sprite {
            width: 40px;
            height: 40px;
            image-rendering: pixelated;
        }

        .battle-log {
            height: 150px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            font-size: 12px;
            margin-bottom: 20px;
        }

        .battle-log-entry {
            margin-bottom: 5px;
            padding: 3px;
            border-left: 3px solid #4CAF50;
            padding-left: 8px;
        }

        .battle-log-entry.damage {
            border-left-color: #e74c3c;
        }

        .battle-log-entry.heal {
            border-left-color: #2ecc71;
        }

        .battle-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            color: #ffeb3b;
        }

        .character-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .character-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .character-card.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .character-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .character-stats {
            font-size: 11px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 6px;
            border-radius: 3px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .item-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #666;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .item-slot:hover {
            border-color: #4CAF50;
        }

        .item-slot.rare {
            border-color: #3498db;
        }

        .item-slot.epic {
            border-color: #9b59b6;
        }

        .item-slot.legendary {
            border-color: #f39c12;
        }

        .item-count {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 1px 4px;
            border-radius: 3px;
        }

        .stage-select {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stage-zone {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .stage-zone:hover {
            transform: scale(1.05);
            border-color: #4CAF50;
        }

        .stage-zone.active {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.3);
        }

        .stage-zone.locked {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .substage-select {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .substage-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .substage-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .substage-btn.active {
            border-color: #ffeb3b;
            background: rgba(255, 235, 59, 0.2);
        }

        .substage-btn.locked {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            font-size: 24px;
            margin-bottom: 20px;
            color: #ffeb3b;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .class-select-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .class-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .class-card:hover {
            border-color: #4CAF50;
            transform: scale(1.05);
        }

        .class-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .class-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .class-stats {
            font-size: 12px;
            text-align: left;
        }

        .damage-number {
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none;
        }

        .damage-number.damage {
            color: #e74c3c;
        }

        .damage-number.heal {
            color: #2ecc71;
        }

        .damage-number.crit {
            color: #f39c12;
            font-size: 28px;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }

        .skill-indicator {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            animation: fadeOut 2s forwards;
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }

        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .equipment-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #666;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .equipment-slot:hover {
            border-color: #4CAF50;
        }

        .equipment-label {
            font-size: 10px;
            color: #aaa;
            margin-top: 5px;
        }

        .crafting-materials {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .material-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            padding: 8px;
            text-align: center;
            font-size: 11px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab.active {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stat-points-available {
            background: rgba(255, 235, 59, 0.2);
            border: 2px solid #ffeb3b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .stat-allocation {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
        }

        .stat-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .stat-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: rgba(76, 175, 80, 0.5);
            color: white;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-btn:hover {
            background: rgba(76, 175, 80, 0.8);
        }

        .stat-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        @keyframes attack-flash {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(2); }
        }

        .attacking {
            animation: attack-flash 0.5s;
        }

        .taking-damage {
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .town-building {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .town-building:hover {
            border-color: #4CAF50;
            transform: scale(1.05);
            background: rgba(76, 175, 80, 0.2);
        }

        .equipment-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .equipment-item:hover {
            border-color: #4CAF50;
            background: rgba(255, 255, 255, 0.1);
        }

        .equipment-item.common {
            border-color: #999;
        }

        .equipment-item.uncommon {
            border-color: #2ecc71;
        }

        .equipment-item.rare {
            border-color: #3498db;
        }

        .equipment-item.epic {
            border-color: #9b59b6;
        }

        .equipment-item.legendary {
            border-color: #f39c12;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Header -->
        <div class="game-header">
            <h1>‚öîÔ∏è Î∞©ÏπòÌòï RPG Í≤åÏûÑ ‚öîÔ∏è</h1>
            <div class="stage-info">
                <span id="current-stage">Íµ¨Ïó≠: A-1</span> |
                <span id="gold-display">Í≥®Îìú: 0</span> |
                <span id="auto-battle-status">ÏûêÎèô Ï†ÑÌà¨: OFF</span>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="main-game">
            <!-- Left Panel: Party Management -->
            <div class="side-panel">
                <div class="panel-title">ÌååÌã∞ Í¥ÄÎ¶¨</div>
                <div class="character-list" id="party-list"></div>
                <button class="btn btn-primary" onclick="game.showCharacterCreation()" style="width: 100%; margin-top: 15px;">
                    ÏÉà Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä
                </button>
            </div>

            <!-- Center Panel: Battle Area -->
            <div class="center-panel">
                <!-- Stage Selection -->
                <div class="panel-title">Ïä§ÌÖåÏù¥ÏßÄ ÏÑ†ÌÉù</div>
                <div class="stage-select" id="zone-select"></div>
                <div class="substage-select" id="substage-select"></div>

                <!-- Battlefield -->
                <div class="battlefield">
                    <div class="team-container" id="player-team"></div>
                    <div style="text-align: center; margin: 20px 0; font-size: 24px;">‚öîÔ∏è VS ‚öîÔ∏è</div>
                    <div class="enemy-container" id="enemy-team"></div>
                </div>

                <!-- Battle Log -->
                <div class="battle-log" id="battle-log"></div>

                <!-- Battle Controls -->
                <div class="battle-controls">
                    <button class="btn btn-success" onclick="game.startBattle()" id="battle-btn">Ï†ÑÌà¨ ÏãúÏûë</button>
                    <button class="btn btn-primary" onclick="game.toggleAutoBattle()" id="auto-battle-btn">ÏûêÎèô Ï†ÑÌà¨</button>
                    <button class="btn btn-primary" onclick="game.showTown()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üèòÔ∏è ÎèÑÏãú</button>
                    <button class="btn btn-danger" onclick="game.saveGame()">Ï†ÄÏû•</button>
                    <button class="btn btn-primary" onclick="game.loadGame()">Î∂àÎü¨Ïò§Í∏∞</button>
                </div>
            </div>

            <!-- Right Panel: Inventory & Crafting -->
            <div class="side-panel">
                <div class="tabs">
                    <div class="tab active" onclick="game.switchTab('inventory')">Ïù∏Î≤§ÌÜ†Î¶¨</div>
                    <div class="tab" onclick="game.switchTab('crafting')">Ï†úÏûë</div>
                </div>

                <div id="inventory-tab" class="tab-content active">
                    <div class="panel-title">ÏàòÏßëÌïú Ïû¨Î£å</div>
                    <div class="inventory-grid" id="materials-grid"></div>
                </div>

                <div id="crafting-tab" class="tab-content">
                    <div class="panel-title">ÏïÑÏù¥ÌÖú Ï†úÏûë</div>
                    <div id="crafting-recipes"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div class="modal" id="character-creation-modal">
        <div class="modal-content">
            <div class="modal-header">ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±</div>
            <label>Ïù¥Î¶Ñ: <input type="text" id="char-name-input" style="padding: 5px; margin-left: 10px;"></label>
            <div class="class-select-grid" id="class-select"></div>
        </div>
    </div>

    <!-- Character Detail Modal -->
    <div class="modal" id="character-detail-modal">
        <div class="modal-content">
            <div class="modal-header" id="char-detail-header">Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏</div>
            <div id="char-detail-content"></div>
            <button class="btn btn-danger" onclick="game.closeModal('character-detail-modal')" style="width: 100%; margin-top: 20px;">Îã´Í∏∞</button>
        </div>
    </div>

    <!-- Town Modal -->
    <div class="modal" id="town-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">üèòÔ∏è ÎßàÏùÑ</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                <div class="town-building" onclick="game.showBlacksmith()">
                    <div style="font-size: 48px; margin-bottom: 10px;">‚öíÔ∏è</div>
                    <div style="font-size: 18px; font-weight: bold;">ÎåÄÏû•Í∞Ñ</div>
                    <div style="font-size: 12px; color: #aaa;">Ïû•ÎπÑ Ï†úÏûë Î∞è Í∞ïÌôî</div>
                </div>
                <div class="town-building" onclick="game.showInn()">
                    <div style="font-size: 48px; margin-bottom: 10px;">üè®</div>
                    <div style="font-size: 18px; font-weight: bold;">Ïó¨Í¥Ä</div>
                    <div style="font-size: 12px; color: #aaa;">Ìú¥Ïãù Î∞è ÌöåÎ≥µ</div>
                </div>
                <div class="town-building" onclick="game.showShop()">
                    <div style="font-size: 48px; margin-bottom: 10px;">üè™</div>
                    <div style="font-size: 18px; font-weight: bold;">ÏÉÅÏ†ê</div>
                    <div style="font-size: 12px; color: #aaa;">ÏïÑÏù¥ÌÖú Íµ¨Îß§ Î∞è ÌåêÎß§</div>
                </div>
                <div class="town-building" onclick="game.showGuild()">
                    <div style="font-size: 48px; margin-bottom: 10px;">üèõÔ∏è</div>
                    <div style="font-size: 18px; font-weight: bold;">Í∏∏Îìú</div>
                    <div style="font-size: 12px; color: #aaa;">ÌÄòÏä§Ìä∏ Î∞è ÏùòÎ¢∞</div>
                </div>
            </div>
            <button class="btn btn-danger" onclick="game.closeModal('town-modal')" style="width: 100%; margin-top: 20px;">ÎÇòÍ∞ÄÍ∏∞</button>
        </div>
    </div>

    <!-- Blacksmith Modal -->
    <div class="modal" id="blacksmith-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">‚öíÔ∏è ÎåÄÏû•Í∞Ñ</div>
            <div class="tabs" style="margin-top: 20px;">
                <div class="tab active" onclick="game.switchBlacksmithTab('craft')">Ï†úÏûë</div>
                <div class="tab" onclick="game.switchBlacksmithTab('upgrade')">Í∞ïÌôî</div>
            </div>
            <div id="blacksmith-content"></div>
            <button class="btn btn-danger" onclick="game.closeModal('blacksmith-modal')" style="width: 100%; margin-top: 20px;">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
        </div>
    </div>

    <!-- Inn Modal -->
    <div class="modal" id="inn-modal">
        <div class="modal-content">
            <div class="modal-header">üè® Ïó¨Í¥Ä</div>
            <div id="inn-content" style="margin-top: 20px;"></div>
            <button class="btn btn-danger" onclick="game.closeModal('inn-modal')" style="width: 100%; margin-top: 20px;">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
        </div>
    </div>

    <!-- Shop Modal -->
    <div class="modal" id="shop-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">üè™ ÏÉÅÏ†ê</div>
            <div id="shop-content" style="margin-top: 20px;"></div>
            <button class="btn btn-danger" onclick="game.closeModal('shop-modal')" style="width: 100%; margin-top: 20px;">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
        </div>
    </div>

    <!-- Guild Modal -->
    <div class="modal" id="guild-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">üèõÔ∏è Í∏∏Îìú</div>
            <div id="guild-content" style="margin-top: 20px;"></div>
            <button class="btn btn-danger" onclick="game.closeModal('guild-modal')" style="width: 100%; margin-top: 20px;">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
        </div>
    </div>

    <script>
        // Game Data & Constants
        const CLASSES = {
            knight: {
                name: 'Í∏∞ÏÇ¨',
                icon: 'üõ°Ô∏è',
                stats: { str: 10, dex: 4, int: 4, hp: 10 },
                skills: [
                    { name: 'Í∞ïÎ†•Ìïú ÏùºÍ≤©', power: 3.0, target: 'single', type: 'physical', turns: 0, selfDefBonus: 1.0, enemyTaunt: true, skillPowerBonus: 0 },
                    { name: 'ÏàòÌò∏Ïùò Ìï®ÏÑ±', power: 2.0, target: 'multi-2', type: 'physical', turns: 0, allyDefBonus: 0.5, enemyTaunt: true, skillPowerBonus: 0 }
                ]
            },
            archer: {
                name: 'Í∂ÅÏàò',
                icon: 'üèπ',
                stats: { str: 6, dex: 10, int: 6, hp: 6 },
                skills: [
                    { name: 'Ï†ÄÍ≤©', power: 5.0, target: 'single', type: 'physical', skillPowerBonus: 0 },
                    { name: 'Ïã†ÏÜçÌïú Í≥µÍ≤©', power: 4.0, target: 'single', type: 'physical', selfDexBonus: 1.0, dexTurns: 2, skillPowerBonus: 0 }
                ]
            },
            priest: {
                name: 'ÏÑ±ÏßÅÏûê',
                icon: '‚úùÔ∏è',
                stats: { str: 8, dex: 4, int: 8, hp: 8 },
                skills: [
                    { name: 'Ïã†ÏÑ±Ìïú Îπõ', power: 1.2, target: 'single', type: 'magic' },
                    { name: 'ÏπòÏú†', power: 1.5, target: 'ally', type: 'heal' }
                ]
            },
            rogue: {
                name: 'ÎèÑÏ†Å',
                icon: 'üó°Ô∏è',
                stats: { str: 8, dex: 8, int: 6, hp: 6 },
                skills: [
                    { name: 'ÏÉùÎ™ÖÎ†• Ìù°Ïàò', power: 1.5, target: 'single', type: 'physical', lifesteal: 0.5, skillPowerBonus: 0 },
                    { name: 'Í∑∏Î¶ºÏûê ÏùÄÏã†', power: 2.0, target: 'single', type: 'physical', selfDexBonus: 1.0, dexTurns: 3, skillPowerBonus: 0 }
                ]
            },
            druid: {
                name: 'ÎìúÎ£®Ïù¥Îìú',
                icon: 'üåø',
                stats: { str: 8, dex: 6, int: 6, hp: 8 },
                skills: [
                    { name: 'Í≥∞ Î≥ÄÏã†', power: 2.0, target: 'single', type: 'physical', transform: 'bear', transformTurns: 3, skillPowerBonus: 0 },
                    { name: 'ÎäëÎåÄ Î≥ÄÏã†', power: 0, target: 'self', type: 'buff', transform: 'wolf', transformTurns: 3, skillPowerBonus: 0 }
                ]
            },
            mage: {
                name: 'Î≤ïÏÇ¨',
                icon: 'üîÆ',
                stats: { str: 4, dex: 4, int: 10, hp: 6 },
                skills: [
                    { name: 'ÌôîÏóº Ìè≠Î∞ú', power: 4.0, target: 'single', type: 'magic', dot: true, dotTurns: 2, dotPower: 1.0, skillPowerBonus: 0 },
                    { name: 'ÏßÄÏò•Î∂à', power: 2.0, target: 'all', type: 'magic', dot: true, dotTurns: 2, dotPower: 0.2, skillPowerBonus: 0 }
                ]
            },
            healer: {
                name: 'ÏπòÎ£åÏÇ¨',
                icon: 'üíä',
                stats: { str: 4, dex: 4, int: 10, hp: 6 },
                skills: [
                    { name: 'Í∞ïÎ†•Ìïú ÏπòÏú†', power: 4.0, target: 'ally-lowest', type: 'heal', skillPowerBonus: 0 },
                    { name: 'Í¥ëÏó≠ ÏπòÏú†', power: 2.0, target: 'ally-all', type: 'heal', skillPowerBonus: 0 }
                ]
            }
        };

        const ZONES = {
            a: { name: 'ÏñºÏñ¥Î∂ôÏùÄ ÎπôÌïò', theme: 'ice', color: '#7ec8e3' },
            b: { name: 'ÏûëÏó¥ÌïòÎäî Ïö©Ïïî', theme: 'lava', color: '#ff6b35' },
            c: { name: 'Ïã†ÎπÑÎ°úÏö¥ Ïà≤', theme: 'forest', color: '#52b788' },
            d: { name: 'ÍπäÏùÄ Î∞îÎã§', theme: 'ocean', color: '#2a9d8f' },
            e: { name: 'Ïñ¥Îë†Ïùò ÏÑ±Ï±Ñ', theme: 'dark', color: '#6a4c93' }
        };

        const MATERIALS = {
            ice: ['ÏñºÏùå Ï°∞Í∞Å', 'ÏÑúÎ¶¨ Í≤∞Ï†ï', 'ÎπôÌïòÏÑù'],
            lava: ['Ïö©ÏïîÏÑù', 'ÌôîÏóº Ï†ïÏàò', 'ÎßàÍ∑∏Îßà Ìïµ'],
            forest: ['Î™©Ïû¨', 'ÎÇòÎ≠áÍ∞ÄÏßÄ', 'Ïã†ÏÑ†Ìïú Í≥ºÏùº'],
            ocean: ['ÏßÑÏ£º', 'Î±ÉÏ°∞Í∞Å', 'ÎèóÎåÄ'],
            dark: ['Ïñ¥Îë†Ïùò Ï†ïÏàò', 'ÎßùÏûêÏùò Îºà', 'Ï†ÄÏ£ºÎ∞õÏùÄ ÏàòÏ†ï']
        };

        const EQUIPMENT_TYPES = {
            weapon: 'Î¨¥Í∏∞',
            armor: 'Í∞ëÏò∑',
            accessory: 'Ïû•Ïã†Íµ¨'
        };

        const EQUIPMENT_TEMPLATES = {
            // Î¨¥Í∏∞
            ironSword: { name: 'Ï≤†Í≤Ä', type: 'weapon', rarity: 'common', str: 5, dex: 0, int: 0, hp: 0, cost: 100 },
            steelSword: { name: 'Í∞ïÏ≤†Í≤Ä', type: 'weapon', rarity: 'uncommon', str: 10, dex: 0, int: 0, hp: 0, cost: 300 },
            magicStaff: { name: 'ÎßàÎ≤ï ÏßÄÌå°Ïù¥', type: 'weapon', rarity: 'uncommon', str: 0, dex: 0, int: 10, hp: 0, cost: 300 },
            elvenBow: { name: 'ÏóòÌîÑÏùò Ìôú', type: 'weapon', rarity: 'rare', str: 5, dex: 15, int: 0, hp: 0, cost: 600 },
            flameSword: { name: 'ÌôîÏóºÍ≤Ä', type: 'weapon', rarity: 'epic', str: 20, dex: 5, int: 5, hp: 0, cost: 1200 },

            // Í∞ëÏò∑
            leatherArmor: { name: 'Í∞ÄÏ£Ω Í∞ëÏò∑', type: 'armor', rarity: 'common', str: 3, dex: 2, int: 0, hp: 2, cost: 150 },
            chainmail: { name: 'ÏÇ¨Ïä¨ Í∞ëÏò∑', type: 'armor', rarity: 'uncommon', str: 8, dex: 0, int: 0, hp: 5, cost: 400 },
            robeOfMagi: { name: 'ÎßàÎ≤ïÏÇ¨Ïùò Î°úÎ∏å', type: 'armor', rarity: 'rare', str: 0, dex: 3, int: 12, hp: 3, cost: 700 },
            dragonScale: { name: 'Ïö©ÎπÑÎäò Í∞ëÏò∑', type: 'armor', rarity: 'epic', str: 15, dex: 5, int: 5, hp: 10, cost: 1500 },

            // Ïû•Ïã†Íµ¨
            ringOfStrength: { name: 'ÌûòÏùò Î∞òÏßÄ', type: 'accessory', rarity: 'uncommon', str: 5, dex: 0, int: 0, hp: 0, cost: 250 },
            amuletOfWisdom: { name: 'ÏßÄÌòúÏùò Î™©Í±∏Ïù¥', type: 'accessory', rarity: 'rare', str: 0, dex: 0, int: 10, hp: 3, cost: 500 },
            beltOfAgility: { name: 'ÎØºÏ≤©Ïùò ÌóàÎ¶¨Îù†', type: 'accessory', rarity: 'rare', str: 0, dex: 10, int: 0, hp: 2, cost: 500 },
            crownOfKings: { name: 'ÏôïÏùò ÏôïÍ¥Ä', type: 'accessory', rarity: 'legendary', str: 10, dex: 10, int: 10, hp: 10, cost: 3000 }
        };

        const SHOP_ITEMS = {
            healthPotion: { name: 'Ï≤¥Î†• Î¨ºÏïΩ', effect: 'heal', power: 50, cost: 50, description: 'Ï≤¥Î†• 50 ÌöåÎ≥µ' },
            strengthPotion: { name: 'ÌûòÏùò Î¨ºÏïΩ', effect: 'buff-str', power: 5, duration: 10, cost: 200, description: '10Î∂ÑÍ∞Ñ Ìûò +5' },
            expBook: { name: 'Í≤ΩÌóòÏπò Ï±Ö', effect: 'exp', power: 500, cost: 300, description: 'Í≤ΩÌóòÏπò 500 ÌöçÎìù' },
            resetScroll: { name: 'Ïä§ÌÉØ Ï¥àÍ∏∞Ìôî Ï£ºÎ¨∏ÏÑú', effect: 'reset', cost: 1000, description: 'Î™®Îì† Ïä§ÌÉØ Ìè¨Ïù∏Ìä∏ Ï¥àÍ∏∞Ìôî' }
        };

        const GUILD_QUESTS = [
            { id: 1, name: 'Í≥†Î∏îÎ¶∞ ÏÜåÌÉï', description: 'A-5 ÌÅ¥Î¶¨Ïñ¥', reward: 500, requirement: { zone: 'a', stage: 5 } },
            { id: 2, name: 'Ïö©Ïïî ÏßÄÎåÄ ÌÉêÌóò', description: 'B-3 ÌÅ¥Î¶¨Ïñ¥', reward: 800, requirement: { zone: 'b', stage: 3 } },
            { id: 3, name: 'Ïà≤Ïùò ÏàòÌò∏Ïûê', description: 'C-7 ÌÅ¥Î¶¨Ïñ¥', reward: 1200, requirement: { zone: 'c', stage: 7 } },
            { id: 4, name: 'Ïã¨Ìï¥ ÌÉêÌóòÍ∞Ä', description: 'D-5 ÌÅ¥Î¶¨Ïñ¥', reward: 1500, requirement: { zone: 'd', stage: 5 } },
            { id: 5, name: 'Ïñ¥Îë†Ïùò Ï†ïÎ≥µÏûê', description: 'E-10 ÌÅ¥Î¶¨Ïñ¥', reward: 3000, requirement: { zone: 'e', stage: 10 } }
        ];

        // Main Game Object
        const game = {
            party: [],
            currentZone: 'a',
            currentStage: 1,
            unlockedZones: ['a'],
            unlockedStages: { a: 1, b: 1, c: 1, d: 1, e: 1 },
            materials: {},
            gold: 0,
            autoBattle: false,
            inBattle: false,
            enemies: [],
            inventory: [],
            completedQuests: [],

            init() {
                this.renderZoneSelect();
                this.renderSubstageSelect();
                this.renderPartyList();
                this.renderMaterials();
                this.renderCrafting();
                this.updateDisplay();

                // Initialize materials
                Object.values(MATERIALS).flat().forEach(mat => {
                    this.materials[mat] = 0;
                });

                // Create initial character
                this.addCharacter('knight', 'Í∏∞Î≥∏ Í∏∞ÏÇ¨');
            },

            addCharacter(classId, name) {
                if (this.party.length >= 5) {
                    this.addLog('ÌååÌã∞Îäî ÏµúÎåÄ 5Î™ÖÍπåÏßÄÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    return;
                }

                const classData = CLASSES[classId];
                const character = {
                    id: Date.now(),
                    name: name,
                    class: classId,
                    level: 1,
                    exp: 0,
                    expToNext: 100,
                    stats: { ...classData.stats },
                    baseStats: { ...classData.stats },
                    currentHp: classData.stats.hp * 10,
                    maxHp: classData.stats.hp * 10,
                    skills: JSON.parse(JSON.stringify(classData.skills)),
                    equipment: {},
                    availableStats: 0,
                    availableSkillStats: 0,
                    personality: this.generatePersonality(),
                    buffs: [],
                    debuffs: [],
                    transform: null,
                    transformTurns: 0
                };

                this.party.push(character);
                this.renderPartyList();
                this.addLog(`${name}(${classData.name})Ïù¥(Í∞Ä) ÌååÌã∞Ïóê Ìï©Î•òÌñàÏäµÎãàÎã§!`);
            },

            generatePersonality() {
                const traits = ['Ïö©Í∞êÌïú', 'Ïã†Ï§ëÌïú', 'Î¨¥Î™®Ìïú', 'ÏßÄÌòúÎ°úÏö¥', 'ÌñâÏö¥Ïùò'];
                return traits[Math.floor(Math.random() * traits.length)];
            },

            showCharacterCreation() {
                const modal = document.getElementById('character-creation-modal');
                const classSelect = document.getElementById('class-select');

                classSelect.innerHTML = '';
                Object.keys(CLASSES).forEach(classId => {
                    const classData = CLASSES[classId];
                    const card = document.createElement('div');
                    card.className = 'class-card';
                    card.innerHTML = `
                        <div class="class-icon">${classData.icon}</div>
                        <div class="class-name">${classData.name}</div>
                        <div class="class-stats">
                            Ìûò: ${classData.stats.str} | ÎØºÏ≤©: ${classData.stats.dex}<br>
                            ÏßÄÎ†•: ${classData.stats.int} | HP: ${classData.stats.hp}<br>
                            ÌöåÌîº: ${Math.floor(classData.stats.dex / 2)}%
                        </div>
                    `;
                    card.onclick = () => {
                        const name = document.getElementById('char-name-input').value || `${classData.name}${this.party.length + 1}`;
                        this.addCharacter(classId, name);
                        this.closeModal('character-creation-modal');
                        document.getElementById('char-name-input').value = '';
                    };
                    classSelect.appendChild(card);
                });

                modal.classList.add('active');
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            },

            renderPartyList() {
                const container = document.getElementById('party-list');
                container.innerHTML = '';

                this.party.forEach(char => {
                    const classData = CLASSES[char.class];
                    const card = document.createElement('div');
                    card.className = 'character-card';
                    const evasion = Math.floor(char.stats.dex / 2);
                    card.innerHTML = `
                        <div class="character-info">
                            <div>
                                <span style="font-size: 20px;">${classData.icon}</span>
                                <strong>${char.name}</strong> (Lv.${char.level})
                            </div>
                            <div style="font-size: 11px;">${char.personality}</div>
                        </div>
                        <div class="character-stats">
                            <div class="stat-item">HP: ${char.currentHp}/${char.maxHp}</div>
                            <div class="stat-item">ÌöåÌîº: ${evasion}%</div>
                            <div class="stat-item">Ìûò: ${char.stats.str}</div>
                            <div class="stat-item">ÎØºÏ≤©: ${char.stats.dex}</div>
                            <div class="stat-item">ÏßÄÎ†•: ${char.stats.int}</div>
                            <div class="stat-item">EXP: ${char.exp}/${char.expToNext}</div>
                        </div>
                        ${char.availableStats > 0 || char.availableSkillStats > 0 ? `<div style="color: #ffeb3b; margin-top: 5px; font-size: 11px;">Ïä§ÌÉØ: ${char.availableStats} | Ïä§ÌÇ¨: ${char.availableSkillStats}</div>` : ''}
                    `;
                    card.onclick = () => this.showCharacterDetail(char);
                    container.appendChild(card);
                });
            },

            showCharacterDetail(char) {
                const modal = document.getElementById('character-detail-modal');
                const header = document.getElementById('char-detail-header');
                const content = document.getElementById('char-detail-content');

                const classData = CLASSES[char.class];

                header.innerHTML = `${classData.icon} ${char.name} (Lv.${char.level})`;

                let html = `
                    <div style="margin-bottom: 20px;">
                        <strong>ÏßÅÏóÖ:</strong> ${classData.name} | <strong>ÏÑ±Í≤©:</strong> ${char.personality}
                    </div>
                `;

                if (char.availableStats > 0) {
                    html += `
                        <div class="stat-points-available">
                            <strong>ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïä§ÌÉØ Ìè¨Ïù∏Ìä∏: ${char.availableStats}</strong>
                        </div>
                        <div class="stat-allocation">
                            ${this.renderStatAllocation(char)}
                        </div>
                    `;
                }

                // Equipment section
                if (!char.equipment) char.equipment = {};
                html += `
                    <div style="margin-top: 20px;">
                        <strong>Ïû•ÎπÑ:</strong>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            ${['weapon', 'armor', 'accessory'].map(slot => {
                                const equipped = this.inventory.find(item => item.equippedBy === char.name && item.type === slot);
                                return `
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 5px;">
                                        <div style="font-size: 12px; color: #aaa;">${EQUIPMENT_TYPES[slot]}</div>
                                        <select onchange="game.equipItem(${char.id}, '${slot}', this.value)" style="width: 100%; padding: 5px; margin-top: 5px; background: rgba(0,0,0,0.5); color: white; border: 1px solid #666; border-radius: 3px;">
                                            <option value="">ÏóÜÏùå</option>
                                            ${this.inventory.filter(item => item.type === slot && !item.equippedBy).map(item =>
                                                `<option value="${item.id}" ${equipped && equipped.id === item.id ? 'selected' : ''}>${item.name} ${item.upgradeLevel ? `+${item.upgradeLevel}` : ''}</option>`
                                            ).join('')}
                                            ${equipped ? `<option value="${equipped.id}" selected>${equipped.name} ${equipped.upgradeLevel ? `+${equipped.upgradeLevel}` : ''}</option>` : ''}
                                        </select>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <strong>Ïä§ÌÇ¨:</strong><br>
                        ${char.skills.map(skill => `‚Ä¢ ${skill.name} (${skill.type})`).join('<br>')}
                    </div>

                    <div style="margin-top: 20px;">
                        <strong>Í≤ΩÌóòÏπò:</strong> ${char.exp} / ${char.expToNext}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(char.exp / char.expToNext) * 100}%">
                                ${Math.floor((char.exp / char.expToNext) * 100)}%
                            </div>
                        </div>
                    </div>
                `;

                if (char.level >= 30) {
                    html += `
                        <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="game.promoteCharacter(${char.id})">
                            Ï†ÑÏßÅÌïòÍ∏∞ (Lv.1Î°ú Ï¥àÍ∏∞Ìôî, Ïä§ÌÉØ Ïú†ÏßÄ)
                        </button>
                    `;
                }

                content.innerHTML = html;
                modal.classList.add('active');
            },

            renderStatAllocation(char) {
                const stats = ['str', 'dex', 'int', 'hp'];
                const statNames = { str: 'Ìûò', dex: 'ÎØºÏ≤©', int: 'ÏßÄÎ†•', hp: 'ÏÉùÎ™ÖÎ†•' };

                let html = stats.map(stat => `
                    <div class="stat-row">
                        <span>${statNames[stat]}: ${char.stats[stat]}</span>
                        <div class="stat-controls">
                            <button class="stat-btn" onclick="game.allocateStat(${char.id}, '${stat}', -1)" ${char.stats[stat] <= char.baseStats[stat] ? 'disabled' : ''}>-</button>
                            <button class="stat-btn" onclick="game.allocateStat(${char.id}, '${stat}', 1)" ${char.availableStats <= 0 ? 'disabled' : ''}>+</button>
                        </div>
                    </div>
                `).join('');

                if (char.availableSkillStats > 0) {
                    html += `
                        <div style="margin-top: 20px; padding: 10px; background: rgba(76, 175, 80, 0.2); border-radius: 5px;">
                            <strong>ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïä§ÌÇ¨ Ìè¨Ïù∏Ìä∏: ${char.availableSkillStats}</strong>
                        </div>
                        ${char.skills.map((skill, idx) => `
                            <div class="stat-row">
                                <span>${skill.name} (${Math.floor(skill.power * 100 + skill.skillPowerBonus * 10)}%)</span>
                                <div class="stat-controls">
                                    <button class="stat-btn" onclick="game.allocateSkillStat(${char.id}, ${idx}, 1)" ${char.availableSkillStats <= 0 ? 'disabled' : ''}>+</button>
                                </div>
                            </div>
                        `).join('')}
                    `;
                }

                return html;
            },

            allocateStat(charId, stat, amount) {
                const char = this.party.find(c => c.id === charId);
                if (!char) return;

                if (amount > 0 && char.availableStats > 0) {
                    char.stats[stat]++;
                    char.availableStats--;
                    if (stat === 'hp') {
                        char.maxHp += 10;
                        char.currentHp += 10;
                    }
                } else if (amount < 0 && char.stats[stat] > char.baseStats[stat]) {
                    char.stats[stat]--;
                    char.availableStats++;
                    if (stat === 'hp') {
                        char.maxHp -= 10;
                        char.currentHp = Math.min(char.currentHp, char.maxHp);
                    }
                }

                this.showCharacterDetail(char);
                this.renderPartyList();
            },

            allocateSkillStat(charId, skillIndex, amount) {
                const char = this.party.find(c => c.id === charId);
                if (!char || !char.skills[skillIndex]) return;

                if (amount > 0 && char.availableSkillStats > 0) {
                    char.skills[skillIndex].skillPowerBonus += 1;
                    char.availableSkillStats--;
                    this.addLog(`${char.name}Ïùò ${char.skills[skillIndex].name} Ïä§ÌÇ¨Ïù¥ Í∞ïÌôîÎêòÏóàÏäµÎãàÎã§!`);
                }

                this.showCharacterDetail(char);
                this.renderPartyList();
            },

            promoteCharacter(charId) {
                const char = this.party.find(c => c.id === charId);
                if (!char || char.level < 30) return;

                char.level = 1;
                char.exp = 0;
                char.expToNext = 100;
                char.baseStats = { ...char.stats };

                this.addLog(`${char.name}Ïù¥(Í∞Ä) Ï†ÑÏßÅÌñàÏäµÎãàÎã§! Î†àÎ≤® 1Î°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏßÄÎßå Î™®Îì† Ïä§ÌÉØÏù¥ Ïú†ÏßÄÎê©ÎãàÎã§.`);
                this.closeModal('character-detail-modal');
                this.renderPartyList();
            },

            renderZoneSelect() {
                const container = document.getElementById('zone-select');
                container.innerHTML = '';

                Object.keys(ZONES).forEach(zoneId => {
                    const zone = ZONES[zoneId];
                    const isUnlocked = this.unlockedZones.includes(zoneId);
                    const div = document.createElement('div');
                    div.className = `stage-zone ${!isUnlocked ? 'locked' : ''} ${this.currentZone === zoneId ? 'active' : ''}`;
                    div.innerHTML = `<strong>${zoneId.toUpperCase()}</strong><br>${zone.name}`;
                    div.style.borderColor = zone.color;

                    if (isUnlocked) {
                        div.onclick = () => {
                            this.currentZone = zoneId;
                            this.renderZoneSelect();
                            this.renderSubstageSelect();
                        };
                    }

                    container.appendChild(div);
                });
            },

            renderSubstageSelect() {
                const container = document.getElementById('substage-select');
                container.innerHTML = '';

                for (let i = 1; i <= 10; i++) {
                    const isUnlocked = i <= this.unlockedStages[this.currentZone];
                    const btn = document.createElement('button');
                    btn.className = `substage-btn ${!isUnlocked ? 'locked' : ''} ${this.currentStage === i ? 'active' : ''}`;
                    btn.textContent = `${this.currentZone.toUpperCase()}-${i}`;

                    if (isUnlocked) {
                        btn.onclick = () => {
                            this.currentStage = i;
                            this.renderSubstageSelect();
                            this.updateDisplay();
                        };
                    }

                    container.appendChild(btn);
                }
            },

            startBattle() {
                if (this.inBattle) return;
                if (this.party.length === 0) {
                    this.addLog('ÌååÌã∞Ïóê Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§!');
                    return;
                }

                this.inBattle = true;
                document.getElementById('battle-btn').disabled = true;

                this.generateEnemies();
                this.renderBattlefield();
                this.addLog('--- Ï†ÑÌà¨ ÏãúÏûë! ---');

                setTimeout(() => this.battleLoop(), 1000);
            },

            generateEnemies() {
                this.enemies = [];
                const zoneIndex = Object.keys(ZONES).indexOf(this.currentZone);
                const stageMultiplier = 1 + ((zoneIndex * 10 + this.currentStage - 1) * 0.15);

                const monsterTypes = [
                    { name: 'Ï†ÑÏÇ¨', icon: '‚öîÔ∏è', type: 'physical', str: 5, dex: 3, int: 2, hp: 5 },
                    { name: 'ÎßàÎ≤ïÏÇ¨', icon: 'üîÆ', type: 'magic', str: 2, dex: 3, int: 5, hp: 4 },
                    { name: 'ÌòºÌï©Ìòï', icon: 'üëπ', type: 'balanced', str: 3, dex: 4, int: 3, hp: 4 }
                ];

                for (let i = 0; i < 3; i++) {
                    const monsterType = monsterTypes[i % 3];
                    const stats = {
                        str: Math.floor(monsterType.str * stageMultiplier),
                        dex: Math.floor(monsterType.dex * stageMultiplier),
                        int: Math.floor(monsterType.int * stageMultiplier),
                        hp: Math.floor(monsterType.hp * stageMultiplier)
                    };

                    this.enemies.push({
                        id: `enemy-${i}`,
                        name: `${monsterType.name} ${i + 1}`,
                        icon: monsterType.icon,
                        type: monsterType.type,
                        stats: stats,
                        currentHp: stats.hp * 10,
                        maxHp: stats.hp * 10,
                        alive: true,
                        buffs: [],
                        debuffs: []
                    });
                }
            },

            battleLoop() {
                if (!this.inBattle) return;

                // Check win/lose conditions
                const aliveParty = this.party.filter(c => c.currentHp > 0);
                const aliveEnemies = this.enemies.filter(e => e.alive);

                if (aliveParty.length === 0) {
                    this.endBattle(false);
                    return;
                }

                if (aliveEnemies.length === 0) {
                    this.endBattle(true);
                    return;
                }

                // Update buff/debuff durations
                this.party.forEach(char => this.updateBuffs(char));
                this.enemies.forEach(enemy => this.updateBuffs(enemy));

                // Build action queue sorted by dexterity
                const actions = [];
                aliveParty.forEach(char => {
                    const dexBonus = this.getStatModifier(char, 'dex');
                    actions.push({ unit: char, isPlayer: true, speed: char.stats.dex * dexBonus });
                });
                aliveEnemies.forEach(enemy => {
                    const dexBonus = this.getStatModifier(enemy, 'dex');
                    actions.push({ unit: enemy, isPlayer: false, speed: enemy.stats.dex * dexBonus });
                });

                // Sort by speed (higher dex = faster)
                actions.sort((a, b) => b.speed - a.speed);

                // Execute actions in order
                actions.forEach((action, index) => {
                    setTimeout(() => {
                        if (action.isPlayer && action.unit.currentHp > 0) {
                            this.performPlayerAction(action.unit);
                        } else if (!action.isPlayer && action.unit.alive) {
                            this.performEnemyAction(action.unit);
                        }
                    }, index * 600);
                });

                setTimeout(() => this.battleLoop(), actions.length * 600 + 800);
            },

            updateBuffs(unit) {
                if (unit.buffs) {
                    unit.buffs = unit.buffs.filter(buff => {
                        buff.turns--;
                        return buff.turns > 0;
                    });
                }
                if (unit.debuffs) {
                    unit.debuffs = unit.debuffs.filter(debuff => {
                        debuff.turns--;
                        if (debuff.type === 'dot' && debuff.turns > 0) {
                            unit.currentHp -= debuff.damage;
                            if (unit.currentHp <= 0) {
                                unit.currentHp = 0;
                                if (unit.alive !== undefined) unit.alive = false;
                            }
                            this.addLog(`${unit.name}Ïù¥(Í∞Ä) ÏßÄÏÜç ÌîºÌï¥ ${debuff.damage}Î•º Î∞õÏïòÏäµÎãàÎã§!`, 'damage');
                        }
                        return debuff.turns > 0;
                    });
                }
                if (unit.transformTurns) {
                    unit.transformTurns--;
                    if (unit.transformTurns <= 0) {
                        unit.transform = null;
                        this.addLog(`${unit.name}Ïùò Î≥ÄÏã†Ïù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§!`);
                    }
                }
            },

            getStatModifier(unit, stat) {
                let modifier = 1.0;
                if (unit.buffs) {
                    unit.buffs.forEach(buff => {
                        if (buff.stat === stat) modifier += buff.amount;
                    });
                }
                if (unit.transform === 'bear') {
                    if (stat === 'str') modifier += 1.0;
                    if (stat === 'hp') modifier += 1.0;
                    if (stat === 'dex') modifier += 1.0;
                } else if (unit.transform === 'wolf') {
                    if (stat === 'dex') modifier += 2.0;
                }
                return modifier;
            },

            performPlayerAction(char) {
                const skill = char.skills[Math.floor(Math.random() * char.skills.length)];

                if (skill.type === 'heal') {
                    this.performHeal(char, skill);
                } else {
                    this.performAttack(char, skill, true);
                }

                this.renderBattlefield();
            },

            performEnemyAction(enemy) {
                const targets = this.party.filter(c => c.currentHp > 0);
                if (targets.length === 0) return;

                const target = targets[Math.floor(Math.random() * targets.length)];

                // Check evasion
                const evasionChance = Math.floor(target.stats.dex / 2);
                if (Math.random() * 100 < evasionChance) {
                    this.addLog(`${target.name}Ïù¥(Í∞Ä) ${enemy.name}Ïùò Í≥µÍ≤©ÏùÑ ÌöåÌîºÌñàÏäµÎãàÎã§!`);
                    this.renderBattlefield();
                    return;
                }

                // Determine attack type based on enemy type
                const isPhysical = enemy.type === 'physical' || (enemy.type === 'balanced' && Math.random() < 0.5);
                let damage;

                if (isPhysical) {
                    const attackPower = enemy.stats.str * this.getStatModifier(enemy, 'str');
                    const defense = target.stats.str * this.getStatModifier(target, 'str');
                    damage = Math.max(1, Math.floor(attackPower - defense));
                } else {
                    const attackPower = enemy.stats.int * this.getStatModifier(enemy, 'int');
                    const defense = target.stats.int * this.getStatModifier(target, 'int');
                    damage = Math.max(1, Math.floor(attackPower - defense));
                }

                target.currentHp = Math.max(0, target.currentHp - damage);
                this.addLog(`${enemy.name}Ïùò ${isPhysical ? 'Î¨ºÎ¶¨' : 'ÎßàÎ≤ï'} Í≥µÍ≤©! ${target.name}Ïù¥(Í∞Ä) ${damage} Îç∞ÎØ∏ÏßÄÎ•º Î∞õÏùå!`, 'damage');

                this.renderBattlefield();
            },

            performAttack(attacker, skill, isPlayer) {
                const targets = this.getTargets(skill, isPlayer);
                if (targets.length === 0) return;

                const skillPower = skill.power + (skill.skillPowerBonus || 0) * 0.1;

                targets.forEach(target => {
                    // Check evasion
                    const evasionChance = Math.floor(target.stats.dex / 2);
                    if (Math.random() * 100 < evasionChance) {
                        this.addLog(`${target.name}Ïù¥(Í∞Ä) ÌöåÌîºÌñàÏäµÎãàÎã§!`);
                        return;
                    }

                    let damage = 0;
                    const strMod = this.getStatModifier(attacker, 'str');
                    const intMod = this.getStatModifier(attacker, 'int');

                    if (skill.type === 'physical') {
                        const attackPower = attacker.stats.str * strMod * skillPower;
                        const defense = target.stats.str * this.getStatModifier(target, 'str');
                        damage = Math.max(1, Math.floor(attackPower - defense));
                    } else if (skill.type === 'magic') {
                        const attackPower = attacker.stats.int * intMod * skillPower;
                        const defense = target.stats.int * this.getStatModifier(target, 'int');
                        damage = Math.max(1, Math.floor(attackPower - defense));
                    }

                    target.currentHp -= damage;
                    if (target.currentHp <= 0) {
                        target.currentHp = 0;
                        if (target.alive !== undefined) target.alive = false;
                    }

                    // Lifesteal
                    if (skill.lifesteal) {
                        const healAmount = Math.floor(damage * skill.lifesteal);
                        attacker.currentHp = Math.min(attacker.currentHp + healAmount, attacker.maxHp);
                        this.addLog(`${attacker.name}Ïù¥(Í∞Ä) ${healAmount} Ï≤¥Î†•ÏùÑ Ìù°ÏàòÌñàÏäµÎãàÎã§!`, 'heal');
                    }

                    // DOT effect
                    if (skill.dot) {
                        const dotDamage = Math.floor(attacker.stats.int * intMod * skill.dotPower);
                        target.debuffs = target.debuffs || [];
                        target.debuffs.push({ type: 'dot', turns: skill.dotTurns, damage: dotDamage });
                    }

                    this.addLog(`${attacker.name}Ïùò ${skill.name}! ${target.name}ÏóêÍ≤å ${damage} Îç∞ÎØ∏ÏßÄ!`, 'damage');
                });

                // Apply buffs
                this.applySkillBuffs(attacker, skill);
            },

            performHeal(healer, skill) {
                const skillPower = skill.power + (skill.skillPowerBonus || 0) * 0.1;
                const healAmount = Math.floor(healer.stats.int * this.getStatModifier(healer, 'int') * skillPower);

                if (skill.target === 'ally-lowest') {
                    const targets = this.party.filter(c => c.currentHp > 0 && c.currentHp < c.maxHp)
                        .sort((a, b) => a.currentHp - b.currentHp);
                    if (targets.length > 0) {
                        const target = targets[0];
                        target.currentHp = Math.min(target.currentHp + healAmount, target.maxHp);
                        this.addLog(`${healer.name}Ïùò ${skill.name}! ${target.name}Ïù¥(Í∞Ä) ${healAmount} ÌöåÎ≥µ!`, 'heal');
                    }
                } else if (skill.target === 'ally-all') {
                    this.party.forEach(char => {
                        if (char.currentHp > 0 && char.currentHp < char.maxHp) {
                            char.currentHp = Math.min(char.currentHp + healAmount, char.maxHp);
                            this.addLog(`${char.name}Ïù¥(Í∞Ä) ${healAmount} ÌöåÎ≥µ!`, 'heal');
                        }
                    });
                }
            },

            getTargets(skill, isPlayer) {
                const enemyList = isPlayer ? this.enemies.filter(e => e.alive) : this.party.filter(c => c.currentHp > 0);

                if (skill.target === 'single') {
                    return enemyList.length > 0 ? [enemyList[Math.floor(Math.random() * enemyList.length)]] : [];
                } else if (skill.target === 'all') {
                    return enemyList;
                } else if (skill.target === 'multi-2') {
                    return enemyList.slice(0, 2);
                }
                return [];
            },

            applySkillBuffs(attacker, skill) {
                // Self defense bonus
                if (skill.selfDefBonus) {
                    attacker.buffs = attacker.buffs || [];
                    attacker.buffs.push({ stat: 'str', amount: skill.selfDefBonus, turns: 2 });
                    attacker.buffs.push({ stat: 'int', amount: skill.selfDefBonus, turns: 2 });
                    this.addLog(`${attacker.name}Ïùò Î∞©Ïñ¥Î†•Ïù¥ ÏÉÅÏäπÌñàÏäµÎãàÎã§!`);
                }

                // Ally defense bonus
                if (skill.allyDefBonus) {
                    this.party.forEach(char => {
                        char.buffs = char.buffs || [];
                        char.buffs.push({ stat: 'str', amount: skill.allyDefBonus, turns: 2 });
                        char.buffs.push({ stat: 'int', amount: skill.allyDefBonus, turns: 2 });
                    });
                    this.addLog(`ÏïÑÍµ∞ Ï†ÑÏ≤¥Ïùò Î∞©Ïñ¥Î†•Ïù¥ ÏÉÅÏäπÌñàÏäµÎãàÎã§!`);
                }

                // Dex bonus
                if (skill.selfDexBonus) {
                    attacker.buffs = attacker.buffs || [];
                    attacker.buffs.push({ stat: 'dex', amount: skill.selfDexBonus, turns: skill.dexTurns || 2 });
                    this.addLog(`${attacker.name}Ïùò ÎØºÏ≤©ÏÑ±Ïù¥ ÏÉÅÏäπÌñàÏäµÎãàÎã§!`);
                }

                // Transform
                if (skill.transform) {
                    attacker.transform = skill.transform;
                    attacker.transformTurns = skill.transformTurns || 3;
                    this.addLog(`${attacker.name}Ïù¥(Í∞Ä) ${skill.transform === 'bear' ? 'Í≥∞' : 'ÎäëÎåÄ'}Î°ú Î≥ÄÏã†ÌñàÏäµÎãàÎã§!`);
                }
            },

            endBattle(victory) {
                this.inBattle = false;
                document.getElementById('battle-btn').disabled = false;

                if (victory) {
                    this.addLog('--- ÏäπÎ¶¨! ---');

                    // Exp and level up
                    const expGain = 50 + this.currentStage * 10;
                    this.party.forEach(char => {
                        if (char.currentHp > 0) {
                            char.exp += expGain;
                            this.checkLevelUp(char);
                        }
                    });

                    // Gold
                    const goldGain = 30 + this.currentStage * 5;
                    this.gold += goldGain;
                    this.addLog(`Í≥®Îìú ${goldGain}ÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!`);

                    // Materials
                    const zone = ZONES[this.currentZone];
                    const materials = MATERIALS[zone.theme];
                    const materialGain = materials[Math.floor(Math.random() * materials.length)];
                    const amount = 1 + Math.floor(Math.random() * 3);
                    this.materials[materialGain] = (this.materials[materialGain] || 0) + amount;
                    this.addLog(`${materialGain} ${amount}Í∞úÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!`);

                    // Unlock next stage
                    if (this.currentStage >= this.unlockedStages[this.currentZone]) {
                        if (this.currentStage < 10) {
                            this.unlockedStages[this.currentZone] = this.currentStage + 1;
                        } else {
                            const nextZone = Object.keys(ZONES)[Object.keys(ZONES).indexOf(this.currentZone) + 1];
                            if (nextZone && !this.unlockedZones.includes(nextZone)) {
                                this.unlockedZones.push(nextZone);
                                this.addLog(`ÏÉàÎ°úÏö¥ Íµ¨Ïó≠ ${ZONES[nextZone].name}Ïù¥(Í∞Ä) Ìï¥Í∏àÎêòÏóàÏäµÎãàÎã§!`);
                            }
                        }
                    }

                    // Heal party and clear buffs
                    this.party.forEach(char => {
                        char.currentHp = char.maxHp;
                        char.buffs = [];
                        char.debuffs = [];
                        char.transform = null;
                        char.transformTurns = 0;
                    });

                    this.renderZoneSelect();
                    this.renderSubstageSelect();
                    this.renderMaterials();

                    if (this.autoBattle) {
                        setTimeout(() => this.startBattle(), 2000);
                    }
                } else {
                    this.addLog('--- Ìå®Î∞∞... ---');
                    // Heal party after defeat and clear buffs
                    this.party.forEach(char => {
                        char.currentHp = char.maxHp;
                        char.buffs = [];
                        char.debuffs = [];
                        char.transform = null;
                        char.transformTurns = 0;
                    });
                }

                this.renderPartyList();
                this.updateDisplay();
            },

            checkLevelUp(char) {
                while (char.exp >= char.expToNext) {
                    char.exp -= char.expToNext;
                    char.level++;
                    char.expToNext = Math.floor(char.expToNext * 1.2);

                    // Regular stat point
                    char.availableStats++;

                    // Bonus stats and skill points at milestones
                    if (char.level % 10 === 0) {
                        const bonus = char.level / 10;
                        char.availableStats += bonus;
                        char.availableSkillStats++;
                        this.addLog(`${char.name}Ïù¥(Í∞Ä) Î†àÎ≤® ${char.level}Ïóê ÎèÑÎã¨! Î≥¥ÎÑàÏä§ Ïä§ÌÉØ ${bonus}Í∞ú + Ïä§ÌÇ¨ Ìè¨Ïù∏Ìä∏ 1Í∞ú ÌöçÎìù!`);
                    } else {
                        this.addLog(`${char.name}Ïù¥(Í∞Ä) Î†àÎ≤® ${char.level}Ïóê ÎèÑÎã¨!`);
                    }

                    char.maxHp += 5;
                    char.currentHp = char.maxHp;
                }
            },

            renderBattlefield() {
                const playerTeam = document.getElementById('player-team');
                const enemyTeam = document.getElementById('enemy-team');

                playerTeam.innerHTML = '';
                this.party.slice(0, 5).forEach(char => {
                    const classData = CLASSES[char.class];
                    const slot = document.createElement('div');
                    slot.className = `character-slot ${char.currentHp > 0 ? 'active' : ''}`;
                    slot.innerHTML = `
                        <div class="character-sprite">${classData.icon}</div>
                        <div class="character-name">${char.name}</div>
                        <div class="character-level">Lv.${char.level}</div>
                        <div class="character-hp-bar">
                            <div class="character-hp-fill" style="width: ${(char.currentHp / char.maxHp) * 100}%"></div>
                        </div>
                    `;
                    playerTeam.appendChild(slot);
                });

                enemyTeam.innerHTML = '';
                this.enemies.forEach(enemy => {
                    const slot = document.createElement('div');
                    slot.className = 'enemy-slot';
                    slot.innerHTML = `
                        <div class="enemy-sprite">${enemy.icon || 'üëπ'}</div>
                        <div class="character-name">${enemy.name}</div>
                        <div class="character-hp-bar">
                            <div class="character-hp-fill" style="width: ${(enemy.currentHp / enemy.maxHp) * 100}%"></div>
                        </div>
                    `;
                    if (!enemy.alive) slot.style.opacity = '0.3';
                    enemyTeam.appendChild(slot);
                });
            },

            renderMaterials() {
                const grid = document.getElementById('materials-grid');
                grid.innerHTML = '';

                Object.entries(this.materials).forEach(([name, count]) => {
                    if (count > 0) {
                        const slot = document.createElement('div');
                        slot.className = 'item-slot';
                        slot.innerHTML = `
                            <div style="font-size: 20px;">üì¶</div>
                            <div class="item-count">${count}</div>
                        `;
                        slot.title = name;
                        grid.appendChild(slot);
                    }
                });
            },

            renderCrafting() {
                const container = document.getElementById('crafting-recipes');
                container.innerHTML = '<div style="font-size: 14px; color: #aaa; text-align: center;">Ï†úÏûë ÏãúÏä§ÌÖúÏùÄ Ï∂îÌõÑ ÏóÖÎç∞Ïù¥Ìä∏ ÏòàÏ†ïÏûÖÎãàÎã§.</div>';
            },

            toggleAutoBattle() {
                this.autoBattle = !this.autoBattle;
                this.updateDisplay();

                if (this.autoBattle && !this.inBattle) {
                    this.startBattle();
                }
            },

            addLog(message, type = 'normal') {
                const log = document.getElementById('battle-log');
                const entry = document.createElement('div');
                entry.className = `battle-log-entry ${type}`;
                entry.textContent = message;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;

                // Keep only last 50 entries
                while (log.children.length > 50) {
                    log.removeChild(log.firstChild);
                }
            },

            updateDisplay() {
                document.getElementById('current-stage').textContent =
                    `Íµ¨Ïó≠: ${this.currentZone.toUpperCase()}-${this.currentStage} (${ZONES[this.currentZone].name})`;
                document.getElementById('gold-display').textContent = `Í≥®Îìú: ${this.gold}`;
                document.getElementById('auto-battle-status').textContent =
                    `ÏûêÎèô Ï†ÑÌà¨: ${this.autoBattle ? 'ON' : 'OFF'}`;
            },

            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                event.target.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            },

            saveGame() {
                const saveData = {
                    party: this.party,
                    currentZone: this.currentZone,
                    currentStage: this.currentStage,
                    unlockedZones: this.unlockedZones,
                    unlockedStages: this.unlockedStages,
                    materials: this.materials,
                    gold: this.gold,
                    inventory: this.inventory,
                    completedQuests: this.completedQuests
                };

                localStorage.setItem('idleRpgSave', JSON.stringify(saveData));
                this.addLog('Í≤åÏûÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
            },

            loadGame() {
                const saveData = localStorage.getItem('idleRpgSave');
                if (!saveData) {
                    this.addLog('Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                try {
                    const data = JSON.parse(saveData);
                    this.party = data.party;

                    // Update old characters to new format
                    this.party.forEach(char => {
                        if (!char.buffs) char.buffs = [];
                        if (!char.debuffs) char.debuffs = [];
                        if (!char.transform) char.transform = null;
                        if (!char.transformTurns) char.transformTurns = 0;
                        if (!char.availableSkillStats) char.availableSkillStats = 0;

                        // Update skills to new format
                        if (char.skills) {
                            char.skills.forEach(skill => {
                                if (skill.skillPowerBonus === undefined) skill.skillPowerBonus = 0;
                            });
                        }
                    });

                    this.currentZone = data.currentZone;
                    this.currentStage = data.currentStage;
                    this.unlockedZones = data.unlockedZones;
                    this.unlockedStages = data.unlockedStages;
                    this.materials = data.materials;
                    this.gold = data.gold;
                    this.inventory = data.inventory || [];
                    this.completedQuests = data.completedQuests || [];

                    this.renderPartyList();
                    this.renderZoneSelect();
                    this.renderSubstageSelect();
                    this.renderMaterials();
                    this.updateDisplay();

                    this.addLog('Í≤åÏûÑÏù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§!');
                } catch (e) {
                    this.addLog('Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            },

            // Town System Functions
            showTown() {
                document.getElementById('town-modal').classList.add('active');
            },

            showBlacksmith() {
                this.closeModal('town-modal');
                document.getElementById('blacksmith-modal').classList.add('active');
                this.switchBlacksmithTab('craft');
            },

            switchBlacksmithTab(tab) {
                const content = document.getElementById('blacksmith-content');

                if (tab === 'craft') {
                    let html = '<div style="margin-top: 20px;"><h3>Ïû•ÎπÑ Ï†úÏûë</h3>';
                    html += '<div style="display: grid; gap: 10px; margin-top: 15px;">';

                    Object.entries(EQUIPMENT_TEMPLATES).forEach(([id, item]) => {
                        html += `
                            <div class="equipment-item ${item.rarity}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${item.name}</strong> (${EQUIPMENT_TYPES[item.type]})
                                        <div style="font-size: 11px; color: #aaa; margin-top: 5px;">
                                            ${item.str > 0 ? `Ìûò +${item.str} ` : ''}
                                            ${item.dex > 0 ? `ÎØºÏ≤© +${item.dex} ` : ''}
                                            ${item.int > 0 ? `ÏßÄÎ†• +${item.int} ` : ''}
                                            ${item.hp > 0 ? `ÏÉùÎ™ÖÎ†• +${item.hp}` : ''}
                                        </div>
                                    </div>
                                    <button class="btn btn-success" onclick="game.craftEquipment('${id}')"
                                        ${this.gold < item.cost ? 'disabled' : ''}>
                                        Ï†úÏûë (${item.cost}G)
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div></div>';
                    content.innerHTML = html;
                } else if (tab === 'upgrade') {
                    let html = '<div style="margin-top: 20px;"><h3>Ïû•ÎπÑ Í∞ïÌôî</h3>';
                    html += '<p style="color: #aaa; margin-top: 10px;">Î≥¥Ïú† Ï§ëÏù∏ Ïû•ÎπÑ:</p>';
                    html += '<div style="display: grid; gap: 10px; margin-top: 15px;">';

                    if (this.inventory.length === 0) {
                        html += '<p style="text-align: center; color: #666;">Î≥¥Ïú† Ï§ëÏù∏ Ïû•ÎπÑÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                    } else {
                        this.inventory.forEach((item, idx) => {
                            const upgradeCost = Math.floor(item.cost * 0.5 * (item.upgradeLevel || 0 + 1));
                            html += `
                                <div class="equipment-item ${item.rarity}">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${item.name} ${item.upgradeLevel ? `+${item.upgradeLevel}` : ''}</strong>
                                            <div style="font-size: 11px; color: #aaa; margin-top: 5px;">
                                                ${item.str > 0 ? `Ìûò +${item.str} ` : ''}
                                                ${item.dex > 0 ? `ÎØºÏ≤© +${item.dex} ` : ''}
                                                ${item.int > 0 ? `ÏßÄÎ†• +${item.int} ` : ''}
                                                ${item.hp > 0 ? `ÏÉùÎ™ÖÎ†• +${item.hp}` : ''}
                                                ${item.equippedBy ? `(${item.equippedBy} Ï∞©Ïö© Ï§ë)` : ''}
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" onclick="game.upgradeEquipment(${idx})"
                                            ${this.gold < upgradeCost || item.equippedBy ? 'disabled' : ''}>
                                            Í∞ïÌôî (${upgradeCost}G)
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    html += '</div></div>';
                    content.innerHTML = html;
                }
            },

            craftEquipment(templateId) {
                const template = EQUIPMENT_TEMPLATES[templateId];
                if (this.gold < template.cost) {
                    this.addLog('Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!');
                    return;
                }

                this.gold -= template.cost;
                const newEquipment = {
                    ...template,
                    id: Date.now(),
                    upgradeLevel: 0
                };
                this.inventory.push(newEquipment);

                this.addLog(`${template.name}ÏùÑ(Î•º) Ï†úÏûëÌñàÏäµÎãàÎã§!`);
                this.updateDisplay();
                this.switchBlacksmithTab('craft');
            },

            upgradeEquipment(index) {
                const item = this.inventory[index];
                const upgradeCost = Math.floor(item.cost * 0.5 * (item.upgradeLevel + 1));

                if (this.gold < upgradeCost) {
                    this.addLog('Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!');
                    return;
                }

                this.gold -= upgradeCost;
                item.upgradeLevel = (item.upgradeLevel || 0) + 1;

                // Increase stats by 20% of base
                const baseTemplate = EQUIPMENT_TEMPLATES[Object.keys(EQUIPMENT_TEMPLATES).find(k =>
                    EQUIPMENT_TEMPLATES[k].name === item.name.split('+')[0].trim()
                )];

                item.str += Math.floor(baseTemplate.str * 0.2);
                item.dex += Math.floor(baseTemplate.dex * 0.2);
                item.int += Math.floor(baseTemplate.int * 0.2);
                item.hp += Math.floor(baseTemplate.hp * 0.2);

                this.addLog(`${item.name}ÏùÑ(Î•º) +${item.upgradeLevel}(Ïúº)Î°ú Í∞ïÌôîÌñàÏäµÎãàÎã§!`);
                this.updateDisplay();
                this.switchBlacksmithTab('upgrade');
            },

            showInn() {
                this.closeModal('town-modal');
                document.getElementById('inn-modal').classList.add('active');

                const content = document.getElementById('inn-content');
                let html = '<div style="text-align: center;">';
                html += '<p style="font-size: 16px; margin-bottom: 20px;">Ïó¨Í¥ÄÏóêÏÑú Ìú¥ÏãùÏùÑ Ï∑®ÌïòÎ©¥ ÌååÌã∞ Ï†ÑÏ≤¥Ïùò Ï≤¥Î†•Ïù¥ ÌöåÎ≥µÎê©ÎãàÎã§.</p>';
                html += '<div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; margin: 20px 0;">';
                html += '<div style="font-size: 48px; margin-bottom: 15px;">üõèÔ∏è</div>';
                html += '<p style="font-size: 14px; color: #aaa; margin-bottom: 20px;">Ìú¥Ïãù ÎπÑÏö©: 50 Í≥®Îìú</p>';
                html += `<button class="btn btn-success" onclick="game.restAtInn()" ${this.gold < 50 ? 'disabled' : ''} style="padding: 15px 40px; font-size: 16px;">Ìú¥ÏãùÌïòÍ∏∞</button>`;
                html += '</div>';
                html += '<p style="font-size: 12px; color: #666; margin-top: 15px;">‚Äª Ï†ÑÌà¨ Ï§ëÏóêÎäî Ïó¨Í¥ÄÏùÑ Ïù¥Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</p>';
                html += '</div>';

                content.innerHTML = html;
            },

            restAtInn() {
                if (this.inBattle) {
                    this.addLog('Ï†ÑÌà¨ Ï§ëÏóêÎäî Ïó¨Í¥ÄÏùÑ Ïù¥Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§!');
                    return;
                }

                if (this.gold < 50) {
                    this.addLog('Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!');
                    return;
                }

                this.gold -= 50;
                this.party.forEach(char => {
                    char.currentHp = char.maxHp;
                });

                this.addLog('ÌååÌã∞Í∞Ä Ïó¨Í¥ÄÏóêÏÑú Ìú¥ÏãùÏùÑ Ï∑®ÌñàÏäµÎãàÎã§. Ï≤¥Î†•Ïù¥ Î™®Îëê ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§!');
                this.updateDisplay();
                this.renderPartyList();
                this.closeModal('inn-modal');
            },

            showShop() {
                this.closeModal('town-modal');
                document.getElementById('shop-modal').classList.add('active');

                const content = document.getElementById('shop-content');
                let html = '<div><h3>üè™ ÏÉÅÏ†ê</h3>';
                html += '<p style="color: #ffeb3b; margin: 10px 0;">Î≥¥Ïú† Í≥®Îìú: ' + this.gold + 'G</p>';
                html += '<div style="display: grid; gap: 10px; margin-top: 15px;">';

                Object.entries(SHOP_ITEMS).forEach(([id, item]) => {
                    html += `
                        <div class="equipment-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${item.name}</strong>
                                    <div style="font-size: 11px; color: #aaa; margin-top: 5px;">${item.description}</div>
                                </div>
                                <button class="btn btn-success" onclick="game.buyItem('${id}')"
                                    ${this.gold < item.cost ? 'disabled' : ''}>
                                    Íµ¨Îß§ (${item.cost}G)
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
                content.innerHTML = html;
            },

            buyItem(itemId) {
                const item = SHOP_ITEMS[itemId];
                if (this.gold < item.cost) {
                    this.addLog('Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!');
                    return;
                }

                this.gold -= item.cost;

                // Apply item effect
                if (item.effect === 'heal') {
                    if (this.party.length > 0) {
                        const char = this.party[0];
                        char.currentHp = Math.min(char.currentHp + item.power, char.maxHp);
                        this.addLog(`${item.name}ÏùÑ(Î•º) ÏÇ¨Ïö©ÌïòÏó¨ ${char.name}Ïùò Ï≤¥Î†•Ïù¥ ${item.power} ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§!`);
                    }
                } else if (item.effect === 'exp') {
                    if (this.party.length > 0) {
                        this.party.forEach(char => {
                            char.exp += item.power;
                            this.checkLevelUp(char);
                        });
                        this.addLog(`${item.name}ÏùÑ(Î•º) ÏÇ¨Ïö©ÌïòÏó¨ ÌååÌã∞ Ï†ÑÏ≤¥Í∞Ä Í≤ΩÌóòÏπò ${item.power}Î•º ÌöçÎìùÌñàÏäµÎãàÎã§!`);
                    }
                } else if (item.effect === 'reset') {
                    this.addLog(`${item.name} Í∏∞Îä•ÏùÄ Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ ÌôîÎ©¥ÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.`);
                }

                this.updateDisplay();
                this.renderPartyList();
                this.showShop();
            },

            showGuild() {
                this.closeModal('town-modal');
                document.getElementById('guild-modal').classList.add('active');

                const content = document.getElementById('guild-content');
                let html = '<div><h3>üèõÔ∏è Í∏∏Îìú ÏùòÎ¢∞</h3>';
                html += '<p style="color: #aaa; margin: 10px 0;">ÌÄòÏä§Ìä∏Î•º ÏôÑÎ£åÌïòÍ≥† Î≥¥ÏÉÅÏùÑ Î∞õÏúºÏÑ∏Ïöî!</p>';
                html += '<div style="display: grid; gap: 10px; margin-top: 15px;">';

                GUILD_QUESTS.forEach(quest => {
                    const isCompleted = this.completedQuests.includes(quest.id);
                    const canComplete = this.unlockedStages[quest.requirement.zone] >= quest.requirement.stage;

                    html += `
                        <div class="equipment-item ${isCompleted ? 'common' : canComplete ? 'uncommon' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${quest.name}</strong> ${isCompleted ? '‚úÖ' : ''}
                                    <div style="font-size: 11px; color: #aaa; margin-top: 5px;">
                                        ${quest.description}<br>
                                        Î≥¥ÏÉÅ: ${quest.reward} Í≥®Îìú
                                    </div>
                                </div>
                                <button class="btn btn-success" onclick="game.completeQuest(${quest.id})"
                                    ${!canComplete || isCompleted ? 'disabled' : ''}>
                                    ${isCompleted ? 'ÏôÑÎ£åÎê®' : canComplete ? 'Î≥¥ÏÉÅ Î∞õÍ∏∞' : 'ÎØ∏Îã¨ÏÑ±'}
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
                content.innerHTML = html;
            },

            completeQuest(questId) {
                const quest = GUILD_QUESTS.find(q => q.id === questId);
                if (!quest || this.completedQuests.includes(questId)) return;

                this.completedQuests.push(questId);
                this.gold += quest.reward;

                this.addLog(`ÌÄòÏä§Ìä∏ "${quest.name}"ÏùÑ(Î•º) ÏôÑÎ£åÌñàÏäµÎãàÎã§! ${quest.reward} Í≥®ÎìúÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!`);
                this.updateDisplay();
                this.showGuild();
            },

            equipItem(charId, slot, itemId) {
                const char = this.party.find(c => c.id === charId);
                if (!char) return;

                // Unequip current item in this slot
                const currentEquipped = this.inventory.find(item => item.equippedBy === char.name && item.type === slot);
                if (currentEquipped) {
                    currentEquipped.equippedBy = null;
                    // Remove stats from character
                    char.stats.str -= currentEquipped.str || 0;
                    char.stats.dex -= currentEquipped.dex || 0;
                    char.stats.int -= currentEquipped.int || 0;
                    char.stats.hp -= currentEquipped.hp || 0;
                    char.maxHp -= (currentEquipped.hp || 0) * 10;
                    char.currentHp = Math.min(char.currentHp, char.maxHp);
                }

                // Equip new item
                if (itemId && itemId !== '') {
                    const newItem = this.inventory.find(item => item.id == itemId);
                    if (newItem) {
                        newItem.equippedBy = char.name;
                        // Add stats to character
                        char.stats.str += newItem.str || 0;
                        char.stats.dex += newItem.dex || 0;
                        char.stats.int += newItem.int || 0;
                        char.stats.hp += newItem.hp || 0;
                        char.maxHp += (newItem.hp || 0) * 10;
                        char.currentHp = Math.min(char.currentHp + (newItem.hp || 0) * 10, char.maxHp);

                        this.addLog(`${char.name}Ïù¥(Í∞Ä) ${newItem.name}ÏùÑ(Î•º) Ïû•Ï∞©ÌñàÏäµÎãàÎã§!`);
                    }
                }

                this.showCharacterDetail(char);
                this.renderPartyList();
            }
        };

        // Initialize game on page load
        window.onload = () => {
            game.init();
        };
    </script>
</body>
</html>