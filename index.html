<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìŠ¤í¬ë¦°ìƒ· ê³„ì‚°ê¸° - ê³ ì •ë°€ OCR v2</title>

  <!-- PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      window['pdfjsLib'].GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }
  </script>

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root {
      --bg: #0a0e27;
      --panel: #151934;
      --border: #2a3150;
      --text: #e4e7f0;
      --muted: #8b92b5;
      --brand: #6366f1;
      --brand-hover: #818cf8;
      --ok: #10b981;
      --warn: #f59e0b;
      --err: #ef4444;
      --accent: #8b5cf6;
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, var(--brand) 0%, var(--accent) 100%);
      padding: 24px 32px;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
    }

    h1 {
      font-size: 28px;
      font-weight: 800;
      color: white;
      display: flex;
      align-items: center;
      gap: 12px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .subtitle {
      font-size: 13px;
      color: rgba(255,255,255,0.9);
      font-weight: 400;
      margin-top: 6px;
    }

    main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 32px;
    }

    .workflow {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .step-card {
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      transition: all 0.3s ease;
    }

    .step-card.active {
      border-color: var(--brand);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
      transform: translateY(-2px);
    }

    .step-card.completed {
      border-color: var(--ok);
    }

    .step-number {
      position: absolute;
      top: -12px;
      left: 20px;
      background: var(--brand);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .step-card.completed .step-number {
      background: var(--ok);
    }

    .step-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      padding-top: 8px;
    }

    .drop-zone {
      border: 3px dashed var(--border);
      border-radius: 12px;
      padding: 48px 24px;
      text-align: center;
      cursor: pointer;
      background: var(--bg);
      transition: all 0.3s ease;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .drop-zone:hover {
      border-color: var(--brand);
      background: rgba(99, 102, 241, 0.05);
    }

    .drop-zone.drag-over {
      border-color: var(--brand);
      background: rgba(99, 102, 241, 0.1);
      border-style: solid;
    }

    .drop-icon {
      font-size: 48px;
      opacity: 0.6;
    }

    .btn {
      background: var(--brand);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .btn:hover:not(:disabled) {
      background: var(--brand-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: var(--ok);
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
    }

    .btn-secondary {
      background: #4b5563;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #6b7280;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover:not(:disabled) {
      border-color: var(--brand);
      color: var(--brand);
    }

    .preview-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 20px;
    }

    .preview-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .preview-box img {
      width: 100%;
      height: auto;
      display: block;
    }

    .preview-label {
      padding: 8px 12px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    .settings-grid {
      display: grid;
      gap: 16px;
      margin-top: 16px;
    }

    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .setting-label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }

    select, input[type="number"] {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      min-width: 180px;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .progress-bar {
      height: 8px;
      background: var(--bg);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 16px;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), var(--accent));
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 999px;
    }

    .status-text {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    .results-container {
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-top: 32px;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .results-title {
      font-size: 20px;
      font-weight: 700;
    }

    .results-actions {
      display: flex;
      gap: 12px;
    }

    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--bg);
      border-radius: 12px;
      overflow: hidden;
    }

    .data-table th {
      background: rgba(99, 102, 241, 0.1);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
      border-bottom: 2px solid var(--border);
    }

    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .data-table tbody tr {
      transition: background 0.2s;
    }

    .data-table tbody tr:hover {
      background: rgba(99, 102, 241, 0.05);
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    .editable-cell {
      background: transparent;
      border: 1px solid transparent;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      color: var(--text);
      width: 100%;
      transition: all 0.2s;
    }

    .editable-cell:hover {
      border-color: var(--border);
    }

    .editable-cell:focus {
      outline: none;
      border-color: var(--brand);
      background: var(--panel);
    }

    .confidence-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .confidence-high {
      background: rgba(16, 185, 129, 0.2);
      color: var(--ok);
    }

    .confidence-medium {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warn);
    }

    .confidence-low {
      background: rgba(239, 68, 68, 0.2);
      color: var(--err);
    }

    .calc-preview {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      padding: 8px 12px;
      background: var(--panel);
      border-radius: 6px;
      border-left: 3px solid var(--border);
    }

    .calc-row {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
    }

    .calc-result {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--border);
      font-weight: 700;
      color: var(--brand);
    }

    .verify-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
    }

    .verify-ok {
      background: rgba(16, 185, 129, 0.2);
      color: var(--ok);
    }

    .verify-warn {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warn);
    }

    .verify-error {
      background: rgba(239, 68, 68, 0.2);
      color: var(--err);
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .summary-card {
      background: var(--bg);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .summary-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .summary-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
    }

    .log-container {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.8;
      margin-top: 24px;
    }

    .log-entry {
      padding: 4px 0;
      color: var(--muted);
    }

    .log-entry .time {
      color: var(--brand);
      margin-right: 8px;
    }

    .log-entry.error {
      color: var(--err);
    }

    .log-entry.success {
      color: var(--ok);
    }

    .empty-state {
      text-align: center;
      padding: 64px 32px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip-text {
      visibility: hidden;
      background: var(--panel);
      color: var(--text);
      text-align: center;
      border-radius: 6px;
      padding: 8px 12px;
      position: absolute;
      z-index: 100;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
    }

    .number-highlight {
      background: rgba(99, 102, 241, 0.2);
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      main {
        padding: 16px;
      }

      .workflow {
        grid-template-columns: 1fr;
      }

      .preview-container {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 22px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>
      ğŸ“Š ìŠ¤í¬ë¦°ìƒ· ê³„ì‚°ê¸°
      <span style="font-size: 14px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 999px;">v2.0 Enhanced</span>
    </h1>
    <div class="subtitle">ê²¬ì ì„œ, ì²­êµ¬ì„œ, ì—‘ì…€ ìŠ¤í¬ë¦°ìƒ·ì˜ ìˆ«ìë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•˜ê³  ê²€ì‚°í•©ë‹ˆë‹¤</div>
  </header>

  <main>
    <!-- ì›Œí¬í”Œë¡œìš° ë‹¨ê³„ -->
    <div class="workflow">
      <!-- 1ë‹¨ê³„: íŒŒì¼ ì—…ë¡œë“œ -->
      <div class="step-card" id="step1">
        <div class="step-number">1</div>
        <div class="step-title">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</div>

        <div class="drop-zone" id="dropZone">
          <input type="file" id="fileInput" accept="image/*,.pdf" multiple hidden />
          <div class="drop-icon">ğŸ“¤</div>
          <div style="font-weight: 600; font-size: 15px;">í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ</div>
          <div style="font-size: 12px; color: var(--muted);">PNG, JPG, PDF ì§€ì›</div>
        </div>

        <div id="fileList" style="margin-top: 16px;"></div>
      </div>

      <!-- 2ë‹¨ê³„: OCR ì„¤ì • -->
      <div class="step-card" id="step2">
        <div class="step-number">2</div>
        <div class="step-title">âš™ï¸ OCR ì„¤ì •</div>

        <div class="settings-grid">
          <div class="setting-row">
            <span class="setting-label">ì¸ì‹ ëª¨ë“œ</span>
            <select id="ocrMode">
              <option value="hybrid" selected>í•˜ì´ë¸Œë¦¬ë“œ (í•œê¸€+ìˆ«ì ë¶„ë¦¬)</option>
              <option value="number-focused">ìˆ«ì ì¤‘ì‹¬ (ìµœê³  ì •í™•ë„)</option>
              <option value="standard">í‘œì¤€ (ë¹ ë¥¸ ì†ë„)</option>
            </select>
          </div>

          <div class="setting-row">
            <span class="setting-label">ì „ì²˜ë¦¬ ê°•ë„</span>
            <select id="preprocessLevel">
              <option value="max" selected>ìµœëŒ€ (ê¶Œì¥)</option>
              <option value="high">ë†’ìŒ</option>
              <option value="medium">ì¤‘ê°„</option>
              <option value="low">ë‚®ìŒ</option>
            </select>
          </div>

          <div class="setting-row">
            <span class="setting-label">ì–¸ì–´</span>
            <select id="language">
              <option value="kor+eng" selected>í•œêµ­ì–´ + ì˜ì–´</option>
              <option value="eng">ì˜ì–´ë§Œ</option>
              <option value="kor">í•œêµ­ì–´ë§Œ</option>
            </select>
          </div>

          <div class="setting-row">
            <span class="setting-label">í—ˆìš© ì˜¤ì°¨ (ì›)</span>
            <input type="number" id="tolerance" value="1" min="0" step="1" style="min-width: 100px;" />
          </div>
        </div>

        <button class="btn" id="startBtn" disabled style="width: 100%; margin-top: 20px;">
          <span id="btnText">OCR ì‹œì‘</span>
        </button>

        <div class="progress-bar" id="progressBar" style="display: none;">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="status-text" id="statusText"></div>
      </div>

      <!-- 3ë‹¨ê³„: ë¯¸ë¦¬ë³´ê¸° -->
      <div class="step-card" id="step3">
        <div class="step-number">3</div>
        <div class="step-title">ğŸ‘ï¸ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</div>

        <div id="previewContainer" class="empty-state">
          <div class="empty-icon">ğŸ–¼ï¸</div>
          <div>íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´<br>ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>

    <!-- ê²°ê³¼ ì„¹ì…˜ -->
    <div class="results-container" id="resultsContainer" style="display: none;">
      <div class="results-header">
        <div class="results-title">ğŸ“‹ ì¸ì‹ ê²°ê³¼</div>
        <div class="results-actions">
          <button class="btn btn-secondary" id="autoCheckBtn">
            âœ¨ ìë™ ê²€ì¦
          </button>
          <button class="btn btn-outline" id="exportBtn">
            ğŸ’¾ CSV ë‚´ë³´ë‚´ê¸°
          </button>
        </div>
      </div>

      <!-- ìš”ì•½ ì¹´ë“œ -->
      <div class="summary-cards" id="summaryCards"></div>

      <!-- ë°ì´í„° í…Œì´ë¸” -->
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 50px;">#</th>
              <th style="width: 80px;">ì‹ ë¢°ë„</th>
              <th style="width: 40%;">ì›ë¬¸ í…ìŠ¤íŠ¸</th>
              <th style="width: 25%;">ì¶”ì¶œëœ ìˆ«ì</th>
              <th style="width: 20%;">ê³„ì‚° ê²°ê³¼</th>
              <th style="width: 15%;">ê²€ì¦</th>
            </tr>
          </thead>
          <tbody id="dataTableBody"></tbody>
        </table>
      </div>

      <!-- ë¡œê·¸ -->
      <div class="log-container" id="logContainer"></div>
    </div>
  </main>

  <script>
    // ==================== ì „ì—­ ë³€ìˆ˜ ====================
    const state = {
      files: [],
      ocrResults: [],
      workers: {
        korean: null,
        english: null
      },
      currentImage: null,
      logs: []
    };

    // ==================== DOM ìš”ì†Œ ====================
    const $ = id => document.getElementById(id);
    const dropZone = $('dropZone');
    const fileInput = $('fileInput');
    const fileList = $('fileList');
    const startBtn = $('startBtn');
    const btnText = $('btnText');
    const progressBar = $('progressBar');
    const progressFill = $('progressFill');
    const statusText = $('statusText');
    const previewContainer = $('previewContainer');
    const resultsContainer = $('resultsContainer');
    const dataTableBody = $('dataTableBody');
    const summaryCards = $('summaryCards');
    const logContainer = $('logContainer');
    const autoCheckBtn = $('autoCheckBtn');
    const exportBtn = $('exportBtn');

    const step1 = $('step1');
    const step2 = $('step2');
    const step3 = $('step3');

    // ==================== ë¡œê¹… ====================
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString('ko-KR');
      const entry = { time, message, type };
      state.logs.push(entry);

      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.innerHTML = `<span class="time">[${time}]</span>${message}`;
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;

      console.log(`[${time}] ${message}`);
    }

    // ==================== íŒŒì¼ ì—…ë¡œë“œ ====================
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      state.files = Array.from(files).filter(f =>
        f.type.startsWith('image/') || f.type === 'application/pdf'
      );

      if (state.files.length === 0) {
        alert('ì´ë¯¸ì§€ ë˜ëŠ” PDF íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      displayFileList();
      showPreview(state.files[0]);
      startBtn.disabled = false;
      step1.classList.add('completed');
      step2.classList.add('active');

      log(`${state.files.length}ê°œ íŒŒì¼ ì—…ë¡œë“œë¨`, 'success');
    }

    function displayFileList() {
      fileList.innerHTML = state.files.map((f, i) => `
        <div style="padding: 8px; background: var(--bg); border-radius: 6px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ğŸ“„ ${f.name}
          </span>
          <span style="font-size: 11px; color: var(--muted);">
            ${(f.size / 1024).toFixed(1)} KB
          </span>
        </div>
      `).join('');
    }

    // ==================== ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ====================
    async function showPreview(file) {
      step3.classList.add('active');

      let imageUrl;
      if (file.type === 'application/pdf') {
        const canvas = await renderPdfToCanvas(file);
        imageUrl = canvas.toDataURL('image/png');
      } else {
        imageUrl = URL.createObjectURL(file);
      }

      state.currentImage = imageUrl;

      previewContainer.innerHTML = `
        <div class="preview-box">
          <img src="${imageUrl}" alt="Preview" />
          <div class="preview-label">ì›ë³¸ ì´ë¯¸ì§€</div>
        </div>
      `;
    }

    async function renderPdfToCanvas(file) {
      if (!window['pdfjsLib']) throw new Error('PDF.js ë¡œë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      const arrayBuffer = await file.arrayBuffer();
      const pdf = await window['pdfjsLib'].getDocument({ data: arrayBuffer }).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 3.0 });

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, viewport.width, viewport.height);

      await page.render({ canvasContext: ctx, viewport }).promise;
      return canvas;
    }

    // ==================== ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ====================
    function preprocessImage(canvas, level = 'max') {
      const targetSizes = {
        max: 4000,
        high: 3000,
        medium: 2500,
        low: 2000
      };

      const targetWidth = targetSizes[level] || 3000;
      const scale = targetWidth / canvas.width;
      const targetHeight = Math.round(canvas.height * scale);

      // ì—…ìŠ¤ì¼€ì¼ë§
      const scaled = document.createElement('canvas');
      scaled.width = targetWidth;
      scaled.height = targetHeight;
      const ctx = scaled.getContext('2d', { willReadFrequently: true });

      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, targetWidth, targetHeight);
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);

      let imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);

      // ê·¸ë ˆì´ìŠ¤ì¼€ì¼
      imageData = toGrayscale(imageData);

      // ë…¸ì´ì¦ˆ ì œê±°
      if (level === 'max' || level === 'high') {
        imageData = denoise(imageData, targetWidth, targetHeight);
      }

      // ëŒ€ë¹„ í–¥ìƒ
      imageData = enhanceContrast(imageData);

      // ì ì‘í˜• ì´ì§„í™”
      imageData = adaptiveThreshold(imageData, targetWidth, targetHeight, level);

      // ì„ ëª…í™”
      if (level === 'max') {
        imageData = sharpen(imageData, targetWidth, targetHeight);
      }

      ctx.putImageData(imageData, 0, 0);
      return scaled;
    }

    function toGrayscale(imageData) {
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        data[i] = data[i + 1] = data[i + 2] = gray;
      }
      return imageData;
    }

    function denoise(imageData, width, height) {
      const data = imageData.data;
      const output = new Uint8ClampedArray(data);

      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          const neighbors = [];
          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              const idx = ((y + dy) * width + (x + dx)) * 4;
              neighbors.push(data[idx]);
            }
          }
          neighbors.sort((a, b) => a - b);
          const median = neighbors[4];

          const idx = (y * width + x) * 4;
          output[idx] = output[idx + 1] = output[idx + 2] = median;
        }
      }

      return new ImageData(output, width, height);
    }

    function enhanceContrast(imageData) {
      const data = imageData.data;
      const histogram = new Array(256).fill(0);

      for (let i = 0; i < data.length; i += 4) {
        histogram[data[i]]++;
      }

      const cdf = new Array(256);
      cdf[0] = histogram[0];
      for (let i = 1; i < 256; i++) {
        cdf[i] = cdf[i - 1] + histogram[i];
      }

      const cdfMin = cdf.find(v => v > 0);
      const totalPixels = data.length / 4;
      const lookupTable = cdf.map(v =>
        Math.round(((v - cdfMin) / (totalPixels - cdfMin)) * 255)
      );

      for (let i = 0; i < data.length; i += 4) {
        const newVal = lookupTable[data[i]];
        data[i] = data[i + 1] = data[i + 2] = newVal;
      }

      return imageData;
    }

    function adaptiveThreshold(imageData, width, height, level) {
      const data = imageData.data;
      const output = new Uint8ClampedArray(data);

      const windowSizes = { max: 31, high: 25, medium: 19, low: 15 };
      const windowSize = windowSizes[level] || 25;
      const k = 0.4;
      const R = 128;

      const integral = new Float64Array(width * height);
      const integralSq = new Float64Array(width * height);

      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = (y * width + x) * 4;
          const val = data[idx];

          const above = y > 0 ? integral[(y - 1) * width + x] : 0;
          const left = x > 0 ? integral[y * width + (x - 1)] : 0;
          const aboveLeft = (y > 0 && x > 0) ? integral[(y - 1) * width + (x - 1)] : 0;

          integral[y * width + x] = val + above + left - aboveLeft;

          const aboveSq = y > 0 ? integralSq[(y - 1) * width + x] : 0;
          const leftSq = x > 0 ? integralSq[y * width + (x - 1)] : 0;
          const aboveLeftSq = (y > 0 && x > 0) ? integralSq[(y - 1) * width + (x - 1)] : 0;

          integralSq[y * width + x] = (val * val) + aboveSq + leftSq - aboveLeftSq;
        }
      }

      const halfWindow = Math.floor(windowSize / 2);

      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const x1 = Math.max(0, x - halfWindow);
          const x2 = Math.min(width - 1, x + halfWindow);
          const y1 = Math.max(0, y - halfWindow);
          const y2 = Math.min(height - 1, y + halfWindow);

          const area = (x2 - x1 + 1) * (y2 - y1 + 1);

          const A = (y1 > 0 && x1 > 0) ? integral[(y1 - 1) * width + (x1 - 1)] : 0;
          const B = (y1 > 0) ? integral[(y1 - 1) * width + x2] : 0;
          const C = (x1 > 0) ? integral[y2 * width + (x1 - 1)] : 0;
          const D = integral[y2 * width + x2];

          const sum = D - B - C + A;
          const mean = sum / area;

          const ASq = (y1 > 0 && x1 > 0) ? integralSq[(y1 - 1) * width + (x1 - 1)] : 0;
          const BSq = (y1 > 0) ? integralSq[(y1 - 1) * width + x2] : 0;
          const CSq = (x1 > 0) ? integralSq[y2 * width + (x1 - 1)] : 0;
          const DSq = integralSq[y2 * width + x2];

          const sumSq = DSq - BSq - CSq + ASq;
          const variance = (sumSq / area) - (mean * mean);
          const stdDev = Math.sqrt(Math.max(0, variance));

          const threshold = mean * (1 + k * ((stdDev / R) - 1));

          const idx = (y * width + x) * 4;
          const pixelVal = data[idx];

          const newVal = pixelVal > threshold ? 255 : 0;
          output[idx] = output[idx + 1] = output[idx + 2] = newVal;
        }
      }

      return new ImageData(output, width, height);
    }

    function sharpen(imageData, width, height) {
      const data = imageData.data;
      const output = new Uint8ClampedArray(data);

      const kernel = [-1, -1, -1, -1, 9, -1, -1, -1, -1];

      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          let sum = 0;
          let ki = 0;

          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              const idx = ((y + dy) * width + (x + dx)) * 4;
              sum += data[idx] * kernel[ki++];
            }
          }

          const idx = (y * width + x) * 4;
          const val = Math.max(0, Math.min(255, sum));
          output[idx] = output[idx + 1] = output[idx + 2] = val;
        }
      }

      return new ImageData(output, width, height);
    }

    // ==================== OCR ì›Œì»¤ ê´€ë¦¬ ====================
    async function getWorker(language) {
      if (!state.workers[language]) {
        log(`${language} OCR ì—”ì§„ ì´ˆê¸°í™” ì¤‘...`);
        const lang = language === 'korean' ? 'kor' : 'eng';
        state.workers[language] = await Tesseract.createWorker(lang, 1, {
          logger: m => {
            if (m.status === 'recognizing text' && typeof m.progress === 'number') {
              updateProgress(m.progress * 100);
            }
          }
        });

        await state.workers[language].setParameters({
          tessedit_pageseg_mode: language === 'english' ? '6' : '6',
          tessedit_ocr_engine_mode: '1',
          preserve_interword_spaces: '1',
          user_defined_dpi: '300',
          tessjs_create_hocr: '1',
          tessjs_create_tsv: '1',
          tessedit_char_whitelist: language === 'english' ? '0123456789,.' : '',
          classify_bln_numeric_mode: language === 'english' ? '1' : '0'
        });

        log(`${language} OCR ì—”ì§„ ì¤€ë¹„ ì™„ë£Œ`, 'success');
      }

      return state.workers[language];
    }

    // ==================== í•˜ì´ë¸Œë¦¬ë“œ OCR ====================
    async function performHybridOCR(canvas) {
      log('í•˜ì´ë¸Œë¦¬ë“œ OCR ì‹œì‘: í•œê¸€ê³¼ ìˆ«ìë¥¼ ë³„ë„ë¡œ ì¸ì‹í•©ë‹ˆë‹¤...');

      // 1. í•œê¸€ OCR (ë ˆì´ì•„ì›ƒ ë° í…ìŠ¤íŠ¸ ì¶”ì¶œìš©)
      updateProgress(10);
      statusText.textContent = '1ë‹¨ê³„: í•œê¸€ í…ìŠ¤íŠ¸ ì¸ì‹ ì¤‘...';
      const koreanWorker = await getWorker('korean');
      const koreanResult = await koreanWorker.recognize(canvas);

      // 2. ìˆ«ì íŠ¹í™” OCR (ì˜ë¬¸ ëª¨ë“œë¡œ ìˆ«ìë§Œ ì¶”ì¶œ)
      updateProgress(50);
      statusText.textContent = '2ë‹¨ê³„: ìˆ«ì ì¸ì‹ ì¤‘ (ê³ ì •ë°€ ëª¨ë“œ)...';

      // ìˆ«ì ì˜ì—­ë§Œ ê°•í™”
      const numberCanvas = enhanceForNumbers(canvas);
      const englishWorker = await getWorker('english');
      const englishResult = await englishWorker.recognize(numberCanvas);

      updateProgress(90);
      statusText.textContent = '3ë‹¨ê³„: ê²°ê³¼ ë³‘í•© ì¤‘...';

      // 3. ê²°ê³¼ ë³‘í•©
      const merged = mergeResults(koreanResult.data, englishResult.data);

      log(`í•˜ì´ë¸Œë¦¬ë“œ OCR ì™„ë£Œ: ${merged.lines.length}ê°œ ë¼ì¸ ì¸ì‹`, 'success');
      return merged;
    }

    function enhanceForNumbers(canvas) {
      // ìˆ«ì ì¸ì‹ì„ ìœ„í•œ ì¶”ê°€ ì „ì²˜ë¦¬
      const enhanced = document.createElement('canvas');
      enhanced.width = canvas.width;
      enhanced.height = canvas.height;
      const ctx = enhanced.getContext('2d');

      ctx.drawImage(canvas, 0, 0);
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

      // ì¶”ê°€ ëŒ€ë¹„ ê°•í™”
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        const val = data[i];
        // ê·¹ë‹¨ì  ì´ì§„í™” (ìˆ«ìë¥¼ ë” ì„ ëª…í•˜ê²Œ)
        data[i] = data[i + 1] = data[i + 2] = val > 127 ? 255 : 0;
      }

      ctx.putImageData(imageData, 0, 0);
      return enhanced;
    }

    function mergeResults(koreanData, englishData) {
      const lines = [];

      (koreanData.lines || []).forEach((korLine, idx) => {
        const text = (korLine.text || '').trim();
        if (!text) return;

        // í•œê¸€ ë¼ì¸ì—ì„œ ê¸°ë³¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const line = {
          text: text,
          confidence: korLine.confidence || 0,
          bbox: korLine.bbox,
          words: korLine.words || [],
          numbers: []
        };

        // ê°™ì€ ìœ„ì¹˜ì˜ ì˜ë¬¸ OCR ê²°ê³¼ì—ì„œ ìˆ«ì ì¶”ì¶œ
        const yPos = korLine.bbox.y0;
        const matchingEngLines = (englishData.lines || []).filter(engLine => {
          const engY = engLine.bbox.y0;
          return Math.abs(engY - yPos) < 30; // Y ì¢Œí‘œê°€ ë¹„ìŠ·í•œ ë¼ì¸
        });

        // ìˆ«ì ì¶”ì¶œ (ì˜ë¬¸ OCR ê²°ê³¼ ìš°ì„ )
        matchingEngLines.forEach(engLine => {
          const nums = extractNumbers(engLine.text);
          line.numbers.push(...nums);
        });

        // í•œê¸€ OCR ê²°ê³¼ì—ì„œë„ ìˆ«ì ì¶”ì¶œ (ë³´ì¡°)
        const korNums = extractNumbers(text);
        korNums.forEach(num => {
          if (!line.numbers.includes(num)) {
            line.numbers.push(num);
          }
        });

        // ì¤‘ë³µ ì œê±° ë° ì •ë ¬
        line.numbers = [...new Set(line.numbers)].sort((a, b) => {
          // í…ìŠ¤íŠ¸ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” ìˆœì„œëŒ€ë¡œ ì •ë ¬
          const aPos = text.indexOf(String(a));
          const bPos = text.indexOf(String(b));
          return aPos - bPos;
        });

        lines.push(line);
      });

      return { lines };
    }

    function extractNumbers(text) {
      if (!text) return [];

      // ë” ê°•ë ¥í•œ ìˆ«ì ì¶”ì¶œ
      const patterns = [
        /\d{1,3}(?:[,\s]\d{3})+(?:\.\d+)?/g,  // ì²œë‹¨ìœ„ êµ¬ë¶„ì
        /\d+\.\d+/g,                           // ì†Œìˆ˜ì 
        /\d+/g                                 // ì¼ë°˜ ìˆ«ì
      ];

      const numbers = [];
      const seen = new Set();

      patterns.forEach(pattern => {
        const matches = text.match(pattern);
        if (matches) {
          matches.forEach(match => {
            const cleaned = match.replace(/[,\s]/g, '');
            const num = parseFloat(cleaned);
            if (Number.isFinite(num) && !seen.has(num) && num > 0) {
              seen.add(num);
              numbers.push(num);
            }
          });
        }
      });

      return numbers;
    }

    // ==================== OCR ì‹¤í–‰ ====================
    startBtn.addEventListener('click', async () => {
      if (state.files.length === 0) return;

      startBtn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span> ì²˜ë¦¬ ì¤‘...';
      progressBar.style.display = 'block';
      resultsContainer.style.display = 'none';
      logContainer.innerHTML = '';
      state.logs = [];

      try {
        const file = state.files[0];
        log(`íŒŒì¼ ì²˜ë¦¬ ì‹œì‘: ${file.name}`);

        // ì´ë¯¸ì§€ ë¡œë“œ
        updateProgress(5);
        statusText.textContent = 'ì´ë¯¸ì§€ ë¡œë”© ì¤‘...';
        let baseCanvas;

        if (file.type === 'application/pdf') {
          baseCanvas = await renderPdfToCanvas(file);
        } else {
          baseCanvas = await loadImageToCanvas(file);
        }

        // ì „ì²˜ë¦¬
        updateProgress(10);
        statusText.textContent = 'ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì¤‘...';
        const preprocessLevel = $('preprocessLevel').value;
        const processedCanvas = preprocessImage(baseCanvas, preprocessLevel);

        // ì „ì²˜ë¦¬ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
        const processedUrl = processedCanvas.toDataURL('image/png');
        const currentHtml = previewContainer.innerHTML;
        previewContainer.innerHTML = currentHtml + `
          <div class="preview-box">
            <img src="${processedUrl}" alt="Processed" />
            <div class="preview-label">ì „ì²˜ë¦¬ ì™„ë£Œ (${preprocessLevel})</div>
          </div>
        `;

        // OCR ì‹¤í–‰
        const ocrMode = $('ocrMode').value;
        let ocrData;

        if (ocrMode === 'hybrid' || ocrMode === 'number-focused') {
          ocrData = await performHybridOCR(processedCanvas);
        } else {
          const language = $('language').value;
          const worker = await getWorker(language === 'eng' ? 'english' : 'korean');
          const result = await worker.recognize(processedCanvas);
          ocrData = result.data;
        }

        // ê²°ê³¼ ì²˜ë¦¬
        updateProgress(95);
        statusText.textContent = 'ê²°ê³¼ ë¶„ì„ ì¤‘...';
        processOCRResults(ocrData);

        updateProgress(100);
        statusText.textContent = 'OCR ì™„ë£Œ!';
        step2.classList.add('completed');
        step3.classList.add('completed');

        setTimeout(() => {
          progressBar.style.display = 'none';
          statusText.textContent = '';
        }, 2000);

      } catch (error) {
        log(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
        console.error(error);
        alert('OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      } finally {
        startBtn.disabled = false;
        btnText.textContent = 'OCR ì‹œì‘';
      }
    });

    async function loadImageToCanvas(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d', { willReadFrequently: true });
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, img.width, img.height);
          ctx.drawImage(img, 0, 0);
          URL.revokeObjectURL(img.src);
          resolve(canvas);
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    function updateProgress(percent) {
      progressFill.style.width = percent + '%';
    }

    // ==================== ê²°ê³¼ ì²˜ë¦¬ ë° í‘œì‹œ ====================
    function processOCRResults(data) {
      state.ocrResults = [];

      const lines = data.lines || [];
      lines.forEach((line, idx) => {
        const text = (line.text || '').trim();
        if (!text) return;

        const numbers = line.numbers || extractNumbers(text);
        const confidence = line.confidence || 0;

        // ê³„ì‚° ìˆ˜í–‰
        let calculation = null;
        let verification = null;

        if (numbers.length >= 2) {
          // ë§ˆì§€ë§‰ ìˆ«ìë¥¼ ê²°ê³¼ë¡œ ê°€ì •í•˜ê³ , ë‚˜ë¨¸ì§€ë¥¼ ê³±ì…ˆ
          const operands = numbers.slice(0, -1);
          const expected = numbers[numbers.length - 1];
          const calculated = operands.reduce((a, b) => a * b, 1);
          const diff = Math.abs(calculated - expected);
          const tolerance = Number($('tolerance').value) || 1;

          calculation = {
            operands,
            expected,
            calculated,
            diff
          };

          verification = diff <= tolerance ? 'ok' : (diff <= tolerance * 10 ? 'warn' : 'error');
        }

        state.ocrResults.push({
          id: idx + 1,
          text,
          numbers,
          confidence,
          calculation,
          verification
        });
      });

      displayResults();
      displaySummary();
      resultsContainer.style.display = 'block';

      log(`ì´ ${state.ocrResults.length}ê°œ ë¼ì¸ ì²˜ë¦¬ ì™„ë£Œ`, 'success');
    }

    function displayResults() {
      dataTableBody.innerHTML = '';

      state.ocrResults.forEach(item => {
        const tr = document.createElement('tr');

        // ë²ˆí˜¸
        const tdId = document.createElement('td');
        tdId.textContent = item.id;
        tdId.style.textAlign = 'center';
        tdId.style.fontWeight = '600';

        // ì‹ ë¢°ë„
        const tdConf = document.createElement('td');
        const confClass = item.confidence >= 85 ? 'high' : (item.confidence >= 70 ? 'medium' : 'low');
        tdConf.innerHTML = `<span class="confidence-badge confidence-${confClass}">${item.confidence.toFixed(1)}%</span>`;

        // í…ìŠ¤íŠ¸
        const tdText = document.createElement('td');
        tdText.innerHTML = highlightNumbers(item.text, item.numbers);

        // ìˆ«ì
        const tdNums = document.createElement('td');
        if (item.numbers.length > 0) {
          tdNums.innerHTML = item.numbers.map((n, i) =>
            `<input type="text" class="editable-cell" value="${formatNumber(n)}" data-id="${item.id}" data-idx="${i}" />`
          ).join('<br>');
        } else {
          tdNums.innerHTML = '<span style="color: var(--muted);">ì—†ìŒ</span>';
        }

        // ê³„ì‚°
        const tdCalc = document.createElement('td');
        if (item.calculation) {
          const calc = item.calculation;
          tdCalc.innerHTML = `
            <div class="calc-preview">
              ${calc.operands.map(n => formatNumber(n)).join(' Ã— ')}
              <div class="calc-result">= ${formatNumber(calc.calculated)}</div>
            </div>
          `;
        } else {
          tdCalc.innerHTML = '<span style="color: var(--muted);">-</span>';
        }

        // ê²€ì¦
        const tdVerify = document.createElement('td');
        if (item.verification) {
          const icons = { ok: 'âœ“', warn: 'âš ', error: 'âœ—' };
          const texts = {
            ok: 'ì¼ì¹˜',
            warn: `ì°¨ì´ ${formatNumber(item.calculation.diff)}`,
            error: `ì˜¤ì°¨ ${formatNumber(item.calculation.diff)}`
          };
          tdVerify.innerHTML = `<span class="verify-badge verify-${item.verification}">${icons[item.verification]} ${texts[item.verification]}</span>`;
        } else {
          tdVerify.innerHTML = '<span style="color: var(--muted);">-</span>';
        }

        tr.appendChild(tdId);
        tr.appendChild(tdConf);
        tr.appendChild(tdText);
        tr.appendChild(tdNums);
        tr.appendChild(tdCalc);
        tr.appendChild(tdVerify);

        dataTableBody.appendChild(tr);
      });

      // ìˆ«ì ìˆ˜ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.querySelectorAll('.editable-cell').forEach(input => {
        input.addEventListener('change', (e) => {
          const id = parseInt(e.target.dataset.id);
          const idx = parseInt(e.target.dataset.idx);
          const value = parseFloat(e.target.value.replace(/,/g, ''));

          if (Number.isFinite(value)) {
            const item = state.ocrResults.find(r => r.id === id);
            if (item) {
              item.numbers[idx] = value;
              log(`ë¼ì¸ ${id}ì˜ ìˆ«ì ${idx + 1} ìˆ˜ì •ë¨: ${formatNumber(value)}`);
              // ì¬ê³„ì‚°
              processOCRResults({ lines: state.ocrResults.map(r => ({ text: r.text, numbers: r.numbers, confidence: r.confidence })) });
            }
          }
        });
      });
    }

    function displaySummary() {
      const totalLines = state.ocrResults.length;
      const avgConfidence = totalLines > 0
        ? state.ocrResults.reduce((sum, r) => sum + r.confidence, 0) / totalLines
        : 0;
      const verified = state.ocrResults.filter(r => r.verification === 'ok').length;
      const errors = state.ocrResults.filter(r => r.verification === 'error').length;

      summaryCards.innerHTML = `
        <div class="summary-card">
          <div class="summary-label">ì´ ë¼ì¸ ìˆ˜</div>
          <div class="summary-value">${totalLines}</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">í‰ê·  ì‹ ë¢°ë„</div>
          <div class="summary-value" style="color: ${avgConfidence >= 85 ? 'var(--ok)' : 'var(--warn)'}">
            ${avgConfidence.toFixed(1)}%
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-label">ê²€ì¦ í†µê³¼</div>
          <div class="summary-value" style="color: var(--ok)">${verified}</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">ì˜¤ë¥˜ ê°ì§€</div>
          <div class="summary-value" style="color: ${errors > 0 ? 'var(--err)' : 'var(--muted)'}">
            ${errors}
          </div>
        </div>
      `;
    }

    function highlightNumbers(text, numbers) {
      let highlighted = text;
      numbers.forEach(num => {
        const pattern = new RegExp(num.toString().replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        highlighted = highlighted.replace(pattern, `<span class="number-highlight">${num}</span>`);
      });
      return highlighted;
    }

    function formatNumber(num) {
      if (!Number.isFinite(num)) return '-';
      return num.toLocaleString('ko-KR');
    }

    // ==================== ìë™ ê²€ì¦ ====================
    autoCheckBtn.addEventListener('click', () => {
      log('ìë™ ê²€ì¦ ì‹œì‘...');

      // í•©ê³„ í‚¤ì›Œë“œ ê°ì§€
      const totalKeywords = /í•©ê³„|ì´ê³„|ì†Œê³„|ê³„|ì´ì•¡|total|sum/i;
      const candidates = state.ocrResults.filter(r => totalKeywords.test(r.text));

      if (candidates.length === 0) {
        log('í•©ê³„ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }

      log(`${candidates.length}ê°œì˜ í•©ê³„ í›„ë³´ ë°œê²¬`);

      candidates.forEach(candidate => {
        if (candidate.numbers.length === 0) return;

        const targetValue = candidate.numbers[candidate.numbers.length - 1];
        const beforeLines = state.ocrResults.filter(r => r.id < candidate.id);

        // ì´ì „ ë¼ì¸ë“¤ì˜ ë§ˆì§€ë§‰ ìˆ«ìë“¤ì„ í•©ì‚°
        let sum = 0;
        let count = 0;
        beforeLines.forEach(line => {
          if (line.numbers.length > 0) {
            sum += line.numbers[line.numbers.length - 1];
            count++;
          }
        });

        const diff = Math.abs(sum - targetValue);
        const tolerance = Number($('tolerance').value) || 1;
        const status = diff <= tolerance ? 'âœ“ ì¼ì¹˜' : `âœ— ì°¨ì´ ${formatNumber(diff)}`;

        log(`ë¼ì¸ ${candidate.id} "${candidate.text}": ì˜ˆìƒ ${formatNumber(sum)} vs ì‹¤ì œ ${formatNumber(targetValue)} â†’ ${status}`);
      });

      log('ìë™ ê²€ì¦ ì™„ë£Œ', 'success');
    });

    // ==================== CSV ë‚´ë³´ë‚´ê¸° ====================
    exportBtn.addEventListener('click', () => {
      const headers = ['ë²ˆí˜¸', 'í…ìŠ¤íŠ¸', 'ì¶”ì¶œëœ ìˆ«ì', 'ì‹ ë¢°ë„', 'ê³„ì‚°ê°’', 'ì˜ˆìƒê°’', 'ì°¨ì´', 'ê²€ì¦'];
      const rows = state.ocrResults.map(item => [
        item.id,
        `"${item.text.replace(/"/g, '""')}"`,
        item.numbers.join('; '),
        item.confidence.toFixed(1),
        item.calculation ? item.calculation.calculated : '',
        item.calculation ? item.calculation.expected : '',
        item.calculation ? item.calculation.diff : '',
        item.verification || ''
      ]);

      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ocr_results_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      log('CSV íŒŒì¼ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'success');
    });
  </script>
</body>
</html>
